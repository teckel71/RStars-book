<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>7 Análisis Clúster. | R-Stars: La Guía</title>
<meta name="author" content="">
<meta name="description" content="7.1 Introducción. El análisis de conglomerados o análisis clúster (AC) trata de clasificar individuos o casos asignándolos a grupos homogéneos, de manera que: Cada grupo, conglomerado o clúster...">
<meta name="generator" content="bookdown 0.42 with bs4_book()">
<meta property="og:title" content="7 Análisis Clúster. | R-Stars: La Guía">
<meta property="og:type" content="book">
<meta property="og:url" content="https://teckel71.github.io/RStars-book/análisis-clúster..html">
<meta property="og:image" content="https://teckel71.github.io/RStars-book/figuras/Portada_v3-2.jpg">
<meta property="og:description" content="7.1 Introducción. El análisis de conglomerados o análisis clúster (AC) trata de clasificar individuos o casos asignándolos a grupos homogéneos, de manera que: Cada grupo, conglomerado o clúster...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="7 Análisis Clúster. | R-Stars: La Guía">
<meta name="twitter:description" content="7.1 Introducción. El análisis de conglomerados o análisis clúster (AC) trata de clasificar individuos o casos asignándolos a grupos homogéneos, de manera que: Cada grupo, conglomerado o clúster...">
<meta name="twitter:image" content="https://teckel71.github.io/RStars-book/figuras/Portada_v3-2.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/Inter-0.4.9/font.css" rel="stylesheet">
<link href="libs/JetBrains_Mono-0.4.9/font.css" rel="stylesheet">
<link href="libs/Inter_Tight-0.4.9/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.9.0/transition.js"></script><script src="libs/bs3compat-0.9.0/tabs.js"></script><script src="libs/bs3compat-0.9.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 0em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="assets/styles.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R-Stars: La Guía</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li><a class="" href="prefacio.html">Prefacio</a></li>
<li><a class="" href="introducci%C3%B3n..html"><span class="header-section-number">1</span> Introducción.</a></li>
<li><a class="" href="almacenando-y-manipulando-datos..html"><span class="header-section-number">2</span> Almacenando y manipulando datos.</a></li>
<li><a class="" href="gr%C3%A1ficos..html"><span class="header-section-number">3</span> Gráficos.</a></li>
<li><a class="" href="estad%C3%ADstica-descriptiva..html"><span class="header-section-number">4</span> Estadística descriptiva.</a></li>
<li><a class="" href="an%C3%A1lisis-previo-de-datos..html"><span class="header-section-number">5</span> Análisis previo de datos.</a></li>
<li><a class="" href="componentes-principales..html"><span class="header-section-number">6</span> Componentes principales.</a></li>
<li><a class="active" href="an%C3%A1lisis-cl%C3%BAster..html"><span class="header-section-number">7</span> Análisis Clúster.</a></li>
<li><a class="" href="an%C3%A1lisis-de-la-varianza..html"><span class="header-section-number">8</span> Análisis de la varianza.</a></li>
<li><a class="" href="an%C3%A1lisis-de-regresi%C3%B3n-lineal-m%C3%BAltiple..html"><span class="header-section-number">9</span> Análisis de Regresión Lineal Múltiple.</a></li>
<li><a class="" href="an%C3%A1lisis-de-datos-cualitativos..html"><span class="header-section-number">10</span> Análisis de Datos Cualitativos.</a></li>
<li><a class="" href="bibliograf%C3%ADa.html">Bibliografía</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="análisis-clúster." class="section level1" number="7">
<h1>
<span class="header-section-number">7</span> Análisis Clúster.<a class="anchor" aria-label="anchor" href="#an%C3%A1lisis-cl%C3%BAster."><i class="fas fa-link"></i></a>
</h1>
<div id="introducción.-3" class="section level2" number="7.1">
<h2>
<span class="header-section-number">7.1</span> Introducción.<a class="anchor" aria-label="anchor" href="#introducci%C3%B3n.-3"><i class="fas fa-link"></i></a>
</h2>
<p>El análisis de conglomerados o análisis clúster (AC) trata de clasificar individuos o casos asignándolos a grupos homogéneos, de manera que:</p>
<ul>
<li><p>Cada grupo, conglomerado o clúster contenga a <strong>los casos más parecidos</strong> entre sí, en términos de una serie de variables (<strong>variables clasificadoras</strong>).</p></li>
<li><p><strong>Los grupos</strong> contengan casos que, en general, <strong>sean muy diferentes</strong> a los casos del resto de grupos, de acuerdo con las variables consideradas.</p></li>
</ul>
<p>En general, el proceso de determinación de los grupos, conglomerados o clústeres de casos es el siguiente:</p>
<ul>
<li>Se parte de un conjunto de <strong>n</strong> casos, y para cada uno de ellos se cuenta con el valor de <strong>m</strong> variables clasificadoras.</li>
<li>Se establece una <strong>medida de distancia</strong> que cuantifica lo que dos casos se parecen, <strong>considerando en conjunto</strong> los valores que poseen para las variables clasificadoras.</li>
<li>Se crean los grupos, conglomerados o clústeres con los casos que poseen entre sí una <strong>menor distancia</strong>. Existen dos <strong>enfoques</strong> principales a la hora de crear los grupos de casos a partir de las distancias observadas entre los casos: los <em>métodos jerárquicos</em> y los <em>métodos no-jerárquicos</em>.</li>
<li>Finalmente, se <strong>caracterizan</strong> los grupos, conglomerados o clíusteres obtenidos, y se comparan unos con otros para extraer conclusiones.</li>
</ul>
<p>En lo que respecta a la medida de <strong>distancia</strong> entre los casos, la medida más habitual es la <strong>distancia euclídea</strong>. Así, la distancia euclídea entre dos caso, i e i’, para las m variables clasificadoras x, será:</p>
<p><span class="math display">\[
d(i, i') = \sqrt{\sum_{j=1}^{m} (x_{ij} - x_{i'j})^2}
\]</span> Esta distancia es muy sensible a la escala de las variables clasificadoras. Para evitar este inconveniente, se trabaja con las variables previamente <strong>tipificadas</strong>.</p>
</div>
<div id="métodos-de-agrupación-jerárquicos." class="section level2" number="7.2">
<h2>
<span class="header-section-number">7.2</span> Métodos de agrupación jerárquicos.<a class="anchor" aria-label="anchor" href="#m%C3%A9todos-de-agrupaci%C3%B3n-jer%C3%A1rquicos."><i class="fas fa-link"></i></a>
</h2>
<p>Como se acaba de comentar, existen dos enfoques fundamentales de realizar el análisis clúster, dependiendo de cómo son los métodos de agrupación de los casos (y grupos de casos): el enfoque de los métodos jerárquicos, y el enfoque que reúne a los métodos no-jerárquicos.</p>
<p>Ambos enfoques tienen sus ventajas e inconvenientes, y pueden adaptarse mejor a cada problema concreto. Es importante seleccionar un buen método de agrupación, puesto que pueden proporcionar soluciones muy diferentes entre sí.</p>
<p>En los <strong>métodos jerárquicos,</strong> se van formando sucesivamente grupos como agrupación de otros grupos precedentes, hasta llegar a un único grupo que recoge a todos los individuos; tomando el proceso una <strong>estructura piramidal</strong> (también existen métodos jerárquicos descendientes, que parten de un único grupo que contiene a todos los casos, para acabar el n grupos de un solo caso, aunque son menos frecuentes).</p>
<p>Estos métodos suelen aplicarse cuando hay un número reducido de casos. También, cuando nuestro objetivo pasa por crear <strong>grupos que recojan a todos los casos</strong>, más que definir simplemente tipologías más o menos homogéneas de casos (lo que se obtiene caracterizando los grupos obtenidos). Es decir, cuando se incluyen en el análisis a todos los individuos, incluidos los <em>outliers</em>. De hecho, estos métodos pueden emplearse, de por sí, como técnicas de localización de <em>outliers</em>. Por último, también se suelen emplearse cuando se desconoce a priori el número de grupos, conglomerados o clústeres a formar.</p>
<p>Entre los métodos jerárquicos de agrupación más extendidos, figuran los siguientes:</p>
<ul>
<li><p><strong>Método del vecino más cercano (single linkage):</strong> la distancia que se considera entre grupos es la distancia entre sus elementos más próximos.</p></li>
<li><p><strong>Método del vecino más lejano (complete linkage):</strong> la distancia que se considera entre grupos es la distancia entre sus elementos más lejanos.</p></li>
<li><p><strong>Método de Ward (Ward method):</strong> se unen los grupos que dan lugar a otro grupo cuyos casos tienen una menor suma de los cuadrados de sus distancias respecto al centro de dicho grupo (menor varianza).</p></li>
<li><p><strong>Otros métodos:</strong> vinculación intergrupos (average linkage between groups), vinculación intragrupos (whithin group)…</p></li>
</ul>
<p>De entre ellos, ¿cuál elegir?</p>
<p>La cuestión no es fácil de resolver, y no tiene por qué tener una única respuesta. Por otro lado, cada método proporciona soluciones que pueden variar mucho entre sí. Una estrategia puede pasar por probar con varios métodos y se seleccionar la solución que parezca más coherente desde el punto de vista teórico, y estable desde el punto de vista empírico.</p>
<p>En la práctica, uno de los métodos más utilizados es el <strong>método de Ward</strong>, porque proporciona grupos muy homogéneos, ya que se basa en la minimización de la varianza o dispersión de los elementos que componen cada grupo con respecto a su centro de gravedad o <strong>centroide.</strong> Precisamente, este método será aplicado en el ejemplo práctico que desarrollaremos en R a continuación.</p>
<p>Vamos a considerar una serie de 4 variables que caracterizan a un grupo de 25 empresas de producción eléctrica mediante tecnología eólica. Nuestro objetivo es segmentar este conjunto de empresas, haciendo grupos homogéneos (conglomerados), y caracterizando a dichos grupos. Las variables clasificadoras son: el resultado del ejercicio (RES), el margen de beneficio (MARGEN), los fondos propios (FPIOS) y la solvencia (SOLVENCIA).</p>
<p>Dado que son pocos los casos (empresas) a segmentar, vamos a utilizar un métodos jerárquico de agrupación de casos. En concreto, utilizaremos el <strong>método de Ward</strong>. Así, comenzaremos creando un proyecto de RStudio donde trabajar. Por ejemplo, un proyecto llamado “cluster”. Vamos a ir a la carpeta del proyecto y vamos a guardar en ella los dos archivos de esta práctica: un archivo de Microsoft® Excel® llamado “<a href="https://docs.google.com/spreadsheets/d/1iwD8-e19IM6n_ZykP49i69_f_dLpzosx/edit?usp=sharing&amp;ouid=115375878280465826079&amp;rtpof=true&amp;sd=true">eolica_25.xlsx</a>” y un <em>script</em> denominado “<a href="https://drive.google.com/file/d/1pxGjprMpfP_yqNsaJ-oWKJtfVnSbVZUh/view?usp=sharing">cluster_eolica.R</a>”. Si abrimos el archivo de Microsoft® Excel®, comprobaremos que se compone de tres hojas. La primera muestra un aviso sobre la utilización de los datos, la segunda el nombre y definición de las variables disponibles, y la tercera (hoja “Datos”) guarda los datos que debemos importar desde R-Studio. Estos datos se corresponden con diferentes variables económico-financieras de 25 empresas productoras de electricidad mediante generación eólica.</p>
<p>La primera parte del <em>script</em> se ocupa de importar los datos de la hoja de cálculo, limpiando previamente la memoria (<em>Environment</em>) de posibles objetos almacenados en sesiones anteriores:</p>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># DATOS</span></span>
<span></span>
<span><span class="co"># Importando</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span></span>
<span><span class="va">eolicos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="st">"eolica_25.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"Datos"</span>,</span>
<span>                      na <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"n.d."</span>, <span class="st">"s.d."</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">eolicos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">eolicos</span>, row.names <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span> <span class="op">(</span><span class="va">eolicos</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       RES             ACTIVO             FPIOS             RENECO      
##  Min.   : -5662   Min.   :   85745   Min.   : -77533   Min.   :-2.813  
##  1st Qu.:  2385   1st Qu.:  147743   1st Qu.:  28418   1st Qu.: 1.676  
##  Median :  7121   Median :  230339   Median :  70033   Median : 3.949  
##  Mean   : 41118   Mean   :  965938   Mean   : 461020   Mean   : 3.694  
##  3rd Qu.: 10615   3rd Qu.:  443467   3rd Qu.: 177707   3rd Qu.: 5.125  
##  Max.   :727548   Max.   :13492812   Max.   :6904824   Max.   :12.406  
##  NA's   :1                                             NA's   :2       
## 
##      RENFIN             LIQUIDEZ        ENDEUDA            MARGEN        
##  Min.   :-359.7730   Min.   :0.078   Min.   :  0.917   Min.   :-615.625  
##  1st Qu.:   2.7280   1st Qu.:0.697   1st Qu.: 43.039   1st Qu.:  12.582  
##  Median :  11.3380   Median :1.184   Median : 62.903   Median :  22.792  
##  Mean   :   0.3039   Mean   :1.354   Mean   : 63.599   Mean   :   7.557  
##  3rd Qu.:  24.6330   3rd Qu.:1.550   3rd Qu.: 88.442   3rd Qu.:  39.476  
##  Max.   :  52.2610   Max.   :5.330   Max.   :140.745   Max.   : 223.956  
## 
##    SOLVENCIA         APALANCA           MATRIZ           DIMENSION        
##  Min.   :-40.74   Min.   :-6265.50   Length:25          Length:25         
##  1st Qu.: 11.56   1st Qu.:   13.33   Class :character   Class :character  
##  Median : 37.10   Median :  110.40   Mode  :character   Mode  :character  
##  Mean   : 36.40   Mean   :  -39.90                                        
##  3rd Qu.: 56.96   3rd Qu.:  480.12                                        
##  Max.   : 99.08   Max.   : 1019.62</code></pre>
<p>Podemos observar cómo, en el <em>Environment,</em> ya aparece un objeto. Este objeto es una estructura de datos tipo <em>data frame</em>, se llama “eolicos” y contiene 12 columnas, una por cada una de las variables almacenadas en el archivo de Microsoft® Excel®. De estas variables, dos son de tipo cualitativo (atributos o factores), formadas por cadenas de caracteres: el nombre de la sociedad matriz (grupo empresarial) a la que pertenece (MATRIZ). En realidad, R consideró la primera columna de la hoja de Excel (NOMBRE) como una variable de tipo cualitativo o atributo (por lo que había 13 columnas); pero, al no ser una variable, sino el nombre de los casos o filas (empresas), redefinimos nuestro <em>data frame</em> diciéndole que esa primera columna contenía los nombres de los casos (filas).</p>
<p>En el análisis solo vamos a considerar como variables clasificadoras para construir los grupos o conglomerados las variables RES, MARGEN, FPIOS y SOLVENCIA. Por ello, crearemos con ellas un nuevo <em>data frame</em> llamado “originales” a partir de la función <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> del paquete <a href="https://dplyr.tidyverse.org">dplyr</a>:</p>
<div class="sourceCode" id="cb241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Seleccionando variables clasificadoras para el analisis.</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">originales</span> <span class="op">&lt;-</span> <span class="va">eolicos</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">RES</span>, <span class="va">MARGEN</span>, <span class="va">FPIOS</span>, <span class="va">SOLVENCIA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span> <span class="op">(</span><span class="va">originales</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       RES             MARGEN             FPIOS           SOLVENCIA     
##  Min.   : -5662   Min.   :-615.625   Min.   : -77533   Min.   :-40.74  
##  1st Qu.:  2385   1st Qu.:  12.582   1st Qu.:  28418   1st Qu.: 11.56  
##  Median :  7121   Median :  22.792   Median :  70033   Median : 37.10  
##  Mean   : 41118   Mean   :   7.557   Mean   : 461020   Mean   : 36.40  
##  3rd Qu.: 10615   3rd Qu.:  39.476   3rd Qu.: 177707   3rd Qu.: 56.96  
##  Max.   :727548   Max.   : 223.956   Max.   :6904824   Max.   : 99.08  
##  NA's   :1</code></pre>
<p>El siguiente paso consiste en localizar los posibles <strong><em>missing values</em></strong>, ya que para realizar el análisis es necesario que todos los casos posean dato para todas las variables originales. Para tener una idea general, se puede utilizar la función <code><a href="https://docs.ropensci.org/visdat/reference/vis_miss.html">vis_miss()</a></code> del paquete <a href="https://docs.ropensci.org/visdat/">visdat</a>, que nos localizará gráficamente los <em>missing values</em> de las diferentes variables, y calculará el porcentaje de casos que supone, con respecto al total de observaciones.</p>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Identificando missing values.</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/visdat/">visdat</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/visdat/reference/vis_miss.html">vis_miss</a></span><span class="op">(</span><span class="va">originales</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-203-1.png" width="672"></div>
<p>Una vez puesta de manifiesto la existencia de un <em>missing value</em>, localizaremos el caso concreto que lo contiene aplicando la función <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> de <a href="https://dplyr.tidyverse.org">dplyr</a>. Se trata de la empresa “Biovent Energía S.A.”</p>
<p>Sabemos que ante la existencia de <em>missing values</em>, se puede actuar de varios modos. Por ejemplo, <strong>se puede intentar obtener por otro canal de información el conjunto de valores</strong> que no están disponibles, <strong>o recurrir a alguna estimación</strong>. En caso de que esto sea difícil, se puede optar por <strong>eliminar</strong> estos casos, en especial cuando representan un porcentaje muy reducido respecto al total de casos. En nuestro ejemplo, supondremos que hemos optado por esta última vía, y eliminaremos este caso con otro filtro:</p>
<div class="sourceCode" id="cb244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">RES</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">MARGEN</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">FPIOS</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">SOLVENCIA</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">RES</span>, <span class="va">MARGEN</span>, <span class="va">FPIOS</span>, <span class="va">SOLVENCIA</span><span class="op">)</span>  </span></code></pre></div>
<pre><code>##                    RES MARGEN FPIOS SOLVENCIA
## Biovent Energia SA  NA 22.792 70033    38.082</code></pre>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">originales</span> <span class="op">&lt;-</span> <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">RES</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">MARGEN</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">FPIOS</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">SOLVENCIA</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>El <em>data frame</em> “originales” pasa a tener 24 observaciones, ya que se ha descartado a la empresa a la que le faltaba el dato del resultado del ejercicio (RES).</p>
<p>El siguiente paso es la <strong>identificación de <em>outliers</em>.</strong> Para realizar este proceso, y dado que en nuestro análisis contamos con 4 variables, primero “resumiremos” el valor que toman dichas variables para cada caso, mediante el cálculo de la <em>distancia de Mahalanobis</em>. De hecho, las distancias de los diferentes casos se almacenarán en una nueva variable, a la que llamaremos MAHALANOBIS, que se incorporará al <em>data frame</em> “originales” por medio de la función <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> de <a href="https://dplyr.tidyverse.org">dplyr</a>, y la función <code><a href="https://rdrr.io/r/stats/mahalanobis.html">mahalanobis()</a></code>. Recordemos que, en los diferentes argumentos de esta función, el punto “.” hace referencia al <em>data frame</em> que está delante del operador pipe (%&gt;%).</p>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Identificando outliers.</span></span>
<span></span>
<span><span class="va">originales</span> <span class="op">&lt;-</span> <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>MAHALANOBIS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mahalanobis.html">mahalanobis</a></span><span class="op">(</span><span class="va">.</span>,</span>
<span>                                    center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>                                    cov<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Una vez creada la variable MAHALANOBIS, se estudia la existencia en sus valores de <em>outliers</em> mediante la construcción de un diagrama de caja o <em>boxplot</em>:</p>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">originales</span>, map <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">MAHALANOBIS</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"DISTANCIA DE MAHALANOBIS"</span>, subtitle <span class="op">=</span> <span class="st">"Empresas eólicas"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"MAHALANOBIS"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-206-1.png" width="672"></div>
<p>En el gráfico se observa que existen, por encima de la caja, 4 outliers. Para identificarlos de modo concreto, hemos de calcular los cuartiles primero y tercero de la variable MAHALANOBIS y pasar el correspondiente filtro:</p>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Q1M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span> <span class="op">(</span><span class="va">originales</span><span class="op">$</span><span class="va">MAHALANOBIS</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Q3M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span> <span class="op">(</span><span class="va">originales</span><span class="op">$</span><span class="va">MAHALANOBIS</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span> <span class="op">&gt;</span> <span class="va">Q3M</span> <span class="op">+</span> <span class="fl">1.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span><span class="op">)</span> <span class="op">|</span></span>
<span>         <span class="va">MAHALANOBIS</span> <span class="op">&lt;</span> <span class="va">Q1M</span> <span class="op">-</span> <span class="fl">1.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span>, <span class="va">RES</span>, <span class="va">MARGEN</span>, <span class="va">FPIOS</span>, <span class="va">SOLVENCIA</span><span class="op">)</span></span></code></pre></div>
<pre><code>##                                MAHALANOBIS        RES   MARGEN     FPIOS SOLVENCIA
## Holding De Negocios De GAS SL.    21.77393 727548.000   91.152 6904824.0    51.174
## Global Power Generation SA.       17.67724  39995.000   22.403 1740487.0    86.917
## WPD Wind Investment SL.           10.50395   -850.068 -302.027  108023.8    99.082
## Sargon Energias SLU               14.61446  -2216.000 -615.625  -10985.0   -12.811</code></pre>
<p>Estas empresas cuentan con un valor atípico en la variable MAHALANOBIS lo que, a su vez, implica que muestren valores atípicos en una o varias de las variables originales (RES, MARGEN, FPIOS, SOLVENCIA). En el desarrollo de otras técnicas, en este punto localizaríamos y eliminaríamos los <em>outliers</em>. En este caso <strong>no</strong> lo vamos a hacer, ya que queremos agrupar <strong>todos los casos</strong> que tenemos en el análisis. Precisamente, si hay algún caso que permanece aislado, sin agruparse con otros en el proceso de agrupación hasta las últimas etapas, quizá se trate de un candidato a <em>outlier</em>, por lo que el análisis clúster <strong>también puede considerarse una técnica de localización de casos atípicos</strong>.</p>
<p>Por último, borramos la variable MAHALANOBIS del data frame “originales”, puesto que ya ha cumplido la función de localizar los casos atípicos:</p>
<div class="sourceCode" id="cb251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">originales</span> <span class="op">&lt;-</span> <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">MAHALANOBIS</span><span class="op">)</span></span></code></pre></div>
<p>La siguiente etapa y parte del script se refiere a la aplicación propia del análisis clúster al grupo de casos (24 empresas) que toman valores para las 4 variables incluidas en el análisis.</p>
<p>Los métodos de agrupación usualmente se basan en la <strong>distancia euclídea</strong>. Como la distancia euclídea es sensible a las unidades de medida de las diferentes variables clasificadoras, es preciso trabajar con las <strong>variables tipificadas</strong>, lo que lograremos creando, por ejemplo, un <em>data frame</em> “zoriginales” con la función <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code>. Luego, aplicaremos el método seleccionado a este <em>data frame,</em> en lugar de al <em>data frame</em> que contiene los datos originales sin tipificar:</p>
<div class="sourceCode" id="cb252"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CLUSTER JERARQUICO CON VARIABLES ORIGINALES.</span></span>
<span></span>
<span><span class="co"># Tipificando variables</span></span>
<span></span>
<span><span class="va">zoriginales</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">originales</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span> <span class="op">(</span><span class="va">zoriginales</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       RES              MARGEN             FPIOS           SOLVENCIA       
##  Min.   :-0.3178   Min.   :-3.79391   Min.   :-0.3904   Min.   :-2.13295  
##  1st Qu.:-0.2631   1st Qu.: 0.03333   1st Qu.:-0.3164   1st Qu.:-0.69365  
##  Median :-0.2310   Median : 0.10993   Median :-0.2866   Median :-0.06402  
##  Mean   : 0.0000   Mean   : 0.00000   Mean   : 0.0000   Mean   : 0.00000  
##  3rd Qu.:-0.2072   3rd Qu.: 0.19854   3rd Qu.:-0.2093   3rd Qu.: 0.63264  
##  Max.   : 4.6632   Max.   : 1.32264   Max.   : 4.5230   Max.   : 1.73657</code></pre>
<p>Este nuevo <em>data frame</em> contiene las mismas variables del análisis; pero tipificadas (obsérvese, en el <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>, las medias de las variables).</p>
<p>Previamente a aplicar un método de agrupación concreto, conviene calcular la <strong>matriz de distancias</strong> entre los casos, a la que llamaremos, por ejemplo, “d”. Esta matriz se calcula con la función <code><a href="https://rdrr.io/r/stats/dist.html">dist()</a></code>. Para visualizarla, una opción es representarla mediante el <em>gráfico de temperatura</em> que ofrece la función <code><a href="https://rdrr.io/pkg/factoextra/man/dist.html">fviz_dist()</a></code> del paquete <a href="http://www.sthda.com/english/rpkgs/factoextra">factoextra</a>:</p>
<div class="sourceCode" id="cb254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Matriz de distancias</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span><span class="op">(</span><span class="va">zoriginales</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="http://www.sthda.com/english/rpkgs/factoextra">factoextra</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/factoextra/man/dist.html">fviz_dist</a></span><span class="op">(</span><span class="va">d</span>, lab_size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-210-1.png" width="672"></div>
<p>Los casos con intersecciones en tonos anaranjados tenderán a agruparse con mayor facilidad (o a agruparse antes); mientras que los casos cuyas intersecciones están en tonos azulados tenderán a pertenecer a grupos diferentes (o a agruparse más tarde). Puede observarse cómo las distancias de tres de las empresas que fueron identificadas como <em>outliers</em> (“Holding de Negocios de Gas S. L.”, “Sargon Energías SLU” y “WPD Wind Investment S. L.”) matienen grandes distancias (casillas azuladas) con el resto de empresas. No ocurre lo mismo con la compañía identificada como <em>outlier</em>, “Global Power Generation, S. A.”, que mantiene distancias más discretas como “Viesgo Renovables S. L.”, “Saeta Yield S. A.” o “EDP Renovables España S. L. U.”</p>
<p>Vamos a realizar el análisis clúster jerárquico mediante uno de los métodos más habituales, el de <strong><em>Ward</em></strong>, como es común en las aplicaciones prácticas, ya que este método proporciona grupos muy homogéneos (mínima varianza). La función a utilizar es <code><a href="https://rdrr.io/r/stats/hclust.html">hclust()</a></code>. La solución la guardaremos en el objeto (lista) que hemos llamado, por ejemplo, “cluster_j”. Luego se visualizará el <strong><em>dendograma</em></strong> construido con la función <code><a href="https://rdrr.io/pkg/factoextra/man/fviz_dend.html">fviz_dend()</a></code> del paquete <a href="http://www.sthda.com/english/rpkgs/factoextra">factoextra</a>, que permite personalizar el gráfico con una gramática similar a la utilizada con los gráficos del paquete <a href="https://ggplot2.tidyverse.org">ggplot2</a>:</p>
<div class="sourceCode" id="cb255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Método de Ward.</span></span>
<span></span>
<span><span class="va">cluster_j</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span><span class="op">(</span><span class="va">d</span>, method<span class="op">=</span><span class="st">"ward.D2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/factoextra/man/fviz_dend.html">fviz_dend</a></span><span class="op">(</span><span class="va">cluster_j</span>,</span>
<span>          cex<span class="op">=</span><span class="fl">0.6</span>,</span>
<span>          rect <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>          labels_track_height <span class="op">=</span> <span class="fl">5.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Empresas eólicas"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Método de Ward. Variables originales tipificadas."</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_grey</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: The `&lt;scale&gt;` argument of `guides()` cannot be `FALSE`. Use "none" instead as of ggplot2 3.3.4.
## ℹ The deprecated feature was likely used in the factoextra package.
##   Please report the issue at &lt;https://github.com/kassambara/factoextra/issues&gt;.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-211-1.png" width="672"></div>
<p>En el código anterior:</p>
<ul>
<li><p><strong><code>cluster_j</code></strong>: Es el objeto que contiene el dendrograma que se desea visualizar.</p></li>
<li><p><strong><code>cex = 0.6</code></strong>: Este argumento ajusta el tamaño del texto de las etiquetas en el dendrograma. Un valor de <strong><code>0.6</code></strong> significa que el texto será más pequeño que el tamaño predeterminado.</p></li>
<li><p><strong><code>rect = FALSE</code></strong>: Este argumento indica si se deben dibujar rectángulos alrededor de los clústeres en el dendrograma. <strong><code>FALSE</code></strong> significa que no se dibujarán rectángulos.</p></li>
<li><p><strong><code>labels_track_height = 5.5</code></strong>: Este argumento ajusta la altura de la pista de etiquetas, que es el espacio reservado para las etiquetas de los objetos en el dendrograma. Un valor de <strong><code>5.5</code></strong> proporciona más espacio para las etiquetas.</p></li>
</ul>
<p>Además, el código incluye funciones adicionales para mejorar la visualización:</p>
<ul>
<li><p><strong><code>labs(title = "Empresas eólicas", subtitle = "Método de Ward. Variables originales tipificadas.")</code></strong>: Esta función añade un título y un subtítulo al gráfico.</p></li>
<li><p><strong><code><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_grey()</a></code></strong>: Esta función aplica un tema gris al gráfico, que es el tema predeterminado en ggplot2, proporcionando un fondo gris claro y un estilo de texto específico.</p></li>
</ul>
<p>El eje vertical del <em>dendograma</em> recoge las distancias (o disimilitud) entre los casos y/o grupos previos que se van agrupando sucesivamente. La escala depende de cada método empleado. En el caso del método de <em>Ward</em>, la escala refleja la suma de cuadrados de la distancia de los casos dentro del clúster. Por otro lado, en este ejemplo, es interesante observar que tres de las empresas <em>outliers</em> (“Holding de Negocios de Gas S. L.”, “Sargon Energías SLU” y “WPD Wind Investment S. L.”) se agrupan con el resto de casos (o grupos nprecedentes) en una fase muy tardía del proceso de agrupamiento (muy cerca del único grupo). No es el caso de la tercera empresa identificada como <em>outlier</em>, “Gobal Power Generation S. A.”</p>
<p>Una cuestión importante consiste en determinar con <strong>cuántos grupos</strong> hemos de quedarnos. Aunque existen algoritmos y paquetes de R que aconsejan un número (por ejemplo, la función <code><a href="https://rdrr.io/pkg/NbClust/man/NbClust.html">NbClust()</a></code> del paquete <a href="https://sites.google.com/site/malikacharrad/research/nbclust-package">NbClust</a>); puede ser preferible que el propio investigador decida el número de grupos a crear, mediante la observación del dendograma, y de acuerdo a los objetivos de su propia investigación.</p>
<p>En este ejemplo, un número de grupos razonable podría ser 5, que contaría con el aval de mantener individualizadas a 3 de las empresas etiquetadas como <em>outliers</em>. Si se acepta esta opción, se podrá visualizar de nuevo el dendograma coloreando los grupos formados, con el código siguiente (debe modificarse el código para igualar el argumento <code>k =</code> al número de grupos seleccionado):</p>
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/factoextra/man/fviz_dend.html">fviz_dend</a></span><span class="op">(</span><span class="va">cluster_j</span>,</span>
<span>          cex <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>          k <span class="op">=</span> <span class="fl">5</span>, <span class="co"># número de grupos o conglomerados que se ha decidido formar!</span></span>
<span>          k_colors <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>          labels_track_height <span class="op">=</span> <span class="fl">5.5</span>,</span>
<span>          rect <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          rect_border <span class="op">=</span> <span class="st">"npg"</span>,</span>
<span>          rect_fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Empresas eólicas"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Método de Ward. Variables originales tipificadas."</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_grey</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning in get_col(col, k): Length of color vector was shorter than the number of clusters - color vector was recycled</code></pre>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-212-1.png" width="672"></div>
<p>En el código anterior:</p>
<ul>
<li><p><strong><code>k = 5</code></strong>: Especifica el número de grupos o clústeres que se desea formar en el dendrograma. En este caso, se han decidido formar 5 grupos.</p></li>
<li><p><strong><code>k_colors = "black"</code></strong>: Define el color de las etiquetas de los clústeres. Aquí, se ha elegido el color negro para las etiquetas.</p></li>
<li><p><strong><code>rect = TRUE</code></strong>:Significa que se dibujarán rectángulos delimitando los grupos formados.</p></li>
<li><p><strong><code>rect_border = "npg"</code></strong>: Define el color del borde de los rectángulos que rodean los clústeres. <strong><code>"npg"</code></strong> es un conjunto de colores predefinidos (el de las publicaciones del <em>Nature Publishing Group</em>) en el paquete <strong><a href="https://nanx.me/ggsci/">ggsci</a></strong>, que proporciona paletas de colores científicas.</p></li>
<li><p><strong><code>rect_fill = TRUE</code></strong>: Indica si los rectángulos que rodean los clústeres deben estar rellenos. <strong><code>TRUE</code></strong> significa que los rectángulos estarán rellenos con el color especificado.</p></li>
</ul>
<p>En el dendograma se aprecia cómo hay un grupo formado por 14 empresas, otro de 7, y finalmente 3 grupos individuales (que se corresponden con tres de las empresas que, al comienzo del <em>script</em>, identificamos como <em>outliers</em>).</p>
<p>A continuación vamos a <strong>identificar con mayor detalle los casos</strong> que integran cada uno de los grupos, así como a <strong>caracterizar tales grupos</strong> en función de los valores medios de las variables originales. Para ello, crearemos el vector de valores enteros que indica el grupo al que pertenece cada caso (empresa). A este vector se le llamará, por ejemplo, “whatcluster_j”, y se construirá mediante la función <code><a href="https://rdrr.io/r/stats/cutree.html">cutree()</a></code>, donde el primer argumento es el nombre del objeto que guarda la solución del análisis clúster (“cluster_j”), y el segundo argumento es el número de grupos que hemos decidido crear (k = 5). Conviene convertir esta variable en un factor con la función <code><a href="https://rdrr.io/r/base/factor.html">as.factor()</a></code>, para que deje de ser variable métrica, a efectos de incorporar una leyenda en gráficos posteriores, . Finalmente, ese factor se incorporará al <em>data frame</em> “originales” (importante: no a ”zoriginales”; sino al <em>data frame</em> que contiene a las variables no tipificadas):</p>
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CARACTERIZACIÓN Y COMPOSICIÓN DE GRUPOS.</span></span>
<span></span>
<span><span class="va">originales</span><span class="op">$</span><span class="va">whatcluster_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cutree.html">cutree</a></span><span class="op">(</span><span class="va">cluster_j</span>, k<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">originales</span><span class="op">$</span><span class="va">whatcluster_j</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "1" "2" "3" "4" "5"</code></pre>
<p>Una vez incorporado el grupo de pertenencia de cada empresa al <em>data frame</em> “originales”, se podrán calcular y almacenar las medias de cada grupo de las distintas variables originales, usando las funciones <code>by_group()</code> y <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> de <a href="https://dplyr.tidyverse.org">dplyr</a>. Los decimales se ajustarán utilizando la función <code><a href="https://rdrr.io/r/base/Round.html">round()</a></code>. Toda la información se asigna al <em>data frame</em> “tablamedias” para poder representarla en una tabla mediante las facilidades que ofrecen los paquetes <a href="https://yihui.org/knitr/">knitr</a> y <a href="http://haozhu233.github.io/kableExtra/">kableExtra</a>:</p>
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Tabla con centroides de grupos.</span></span>
<span></span>
<span><span class="va">tablamedias</span> <span class="op">&lt;-</span> <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">whatcluster_j</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">whatcluster_j</span><span class="op">)</span>,</span>
<span>                                        Resultado <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">RES</span><span class="op">)</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>                                        Margen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">MARGEN</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                        Fondos_Propios <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">FPIOS</span><span class="op">)</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>                                        Solvencia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">SOLVENCIA</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span></span>
<span><span class="va">knitr.table.format</span> <span class="op">=</span> <span class="st">"html"</span></span>
<span></span>
<span><span class="va">tablamedias</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>format <span class="op">=</span> <span class="va">knitr.table.format</span>,</span>
<span>        caption <span class="op">=</span> <span class="st">"Método de Ward. 5 grupos. Medias de variables"</span>,</span>
<span>        col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Clúster"</span>, <span class="st">"Observaciones"</span>, <span class="st">"Resultado"</span>, <span class="st">"Margen"</span>,</span>
<span>                      <span class="st">"Fondos Propios"</span>, <span class="st">"Solvencia"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                bootstrap_options <span class="op">=</span> <span class="st">"striped"</span>, <span class="st">"bordered"</span>, <span class="st">"condensed"</span>,</span>
<span>                position <span class="op">=</span> <span class="st">"center"</span>,</span>
<span>                font_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fl">0</span>, bold<span class="op">=</span> <span class="cn">T</span>, align <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">tablamedias</span><span class="op">)</span>, bold<span class="op">=</span> <span class="cn">F</span>, align <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-striped" style="font-size: 11px; width: auto !important; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-215">Table 7.1: </span><span id="tab:unnamed-chunk-215">Table 7.2: </span>Método de Ward. 5 grupos. Medias de variables
</caption>
<thead><tr>
<th style="text-align:left;font-weight: bold;text-align: center;">
Clúster
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Observaciones
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Resultado
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Margen
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Fondos Propios
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Solvencia
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;text-align: center;">
1
</td>
<td style="text-align:right;text-align: center;">
1
</td>
<td style="text-align:right;text-align: center;">
727548
</td>
<td style="text-align:right;text-align: center;">
91.15
</td>
<td style="text-align:right;text-align: center;">
6904824
</td>
<td style="text-align:right;text-align: center;">
51.17
</td>
</tr>
<tr>
<td style="text-align:left;text-align: center;">
2
</td>
<td style="text-align:right;text-align: center;">
7
</td>
<td style="text-align:right;text-align: center;">
19778
</td>
<td style="text-align:right;text-align: center;">
102.31
</td>
<td style="text-align:right;text-align: center;">
523849
</td>
<td style="text-align:right;text-align: center;">
72.75
</td>
</tr>
<tr>
<td style="text-align:left;text-align: center;">
3
</td>
<td style="text-align:right;text-align: center;">
14
</td>
<td style="text-align:right;text-align: center;">
8850
</td>
<td style="text-align:right;text-align: center;">
19.75
</td>
<td style="text-align:right;text-align: center;">
56190
</td>
<td style="text-align:right;text-align: center;">
16.09
</td>
</tr>
<tr>
<td style="text-align:left;text-align: center;">
4
</td>
<td style="text-align:right;text-align: center;">
1
</td>
<td style="text-align:right;text-align: center;">
-850
</td>
<td style="text-align:right;text-align: center;">
-302.03
</td>
<td style="text-align:right;text-align: center;">
108024
</td>
<td style="text-align:right;text-align: center;">
99.08
</td>
</tr>
<tr>
<td style="text-align:left;text-align: center;">
5
</td>
<td style="text-align:right;text-align: center;">
1
</td>
<td style="text-align:right;text-align: center;">
-2216
</td>
<td style="text-align:right;text-align: center;">
-615.62
</td>
<td style="text-align:right;text-align: center;">
-10985
</td>
<td style="text-align:right;text-align: center;">
-12.81
</td>
</tr>
</tbody>
</table></div>
<p>Obviamente, también se podrían comparar las medias de los grupos, para cada variable, con un simple gráfico de barras. A fin de crear un método que valga para cualquier número de variables, realizaremos la tarea con un bucle. El código es el siguiente:</p>
<div class="sourceCode" id="cb262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gráficos de centroides</span></span>
<span></span>
<span>  <span class="co"># Vector de nombre de variables excluyendo la variable no deseada</span></span>
<span>    <span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tablamedias</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"whatcluster_j"</span>, <span class="st">"obs"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Lista para almacenar los gráficos</span></span>
<span>    <span class="va">graficos.centroides</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Bucle para crear y almacenar los gráficos</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">variables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">var1</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">grafico</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span> <span class="va">tablamedias</span>,</span>
<span>                      map <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_.html">aes_string</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">var1</span>, x <span class="op">=</span> <span class="st">"whatcluster_j"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>,</span>
<span>                        colour <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>                        fill <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>                        alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var1</span>, <span class="st">". Media por grupos."</span><span class="op">)</span>,</span>
<span>                       subtitle <span class="op">=</span> <span class="st">"Empresas eólicas"</span><span class="op">)</span><span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span> <span class="op">(</span><span class="st">"Grupo"</span><span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="va">var1</span><span class="op">)</span></span>
<span>    <span class="va">graficos.centroides</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"grafico_"</span>, <span class="va">var1</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">grafico</span></span>
<span><span class="op">}</span>  </span></code></pre></div>
<pre><code>## Warning: `aes_string()` was deprecated in ggplot2 3.0.0.
## ℹ Please use tidy evaluation idioms with `aes()`.
## ℹ See also `vignette("ggplot2-in-packages")` for more information.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
<p>En el código anterior, <code><a href="https://generics.r-lib.org/reference/setops.html">setdiff()</a></code> crea un vector “variables” que contiene todos los nombres de las columnas de <code>tablamedias</code>, excepto <code>"whatcluster_j"</code> y <code>"obs"</code>, que no son las variables originales. Luego se crea una lista vacía “graficos.centroides” para almacenar los gráficos generados. Con <code>for (i in seq_along(variables))</code> comienza el bucle, que recorre cada elemento del vector “variables”. En el código de gráfico, “var1” toma el nombre, en cada iteración, de la variable a representar. En el “mapeo”, es importante utilizar <code><a href="https://ggplot2.tidyverse.org/reference/aes_.html">aes_string()</a></code>, que requiere que los nombres de las variables se pasen como cadenas de texto (entre comillas), lo que es útil cuando los nombres de las variables se generan dinámicamente o se pasan como argumentos de función, y es útil en programación cuando se necesita construir <em>mapeos estéticos</em> de manera programática. Finalmente, con <code>graficos.centroides[[paste0("grafico_", var1)]] &lt;- grafico</code> se guarda el gráfico en la lista “graficos.centroides” con un nombre basado en “var1”.</p>
<p>Los gráficos guardados en la lista “gráficos.centroides” se pueden agrupar en composiciones, de, por ejemplo, 2x2, utilizando el paquete <a href="https://patchwork.data-imaginist.com">patchwork</a>. En esta ocasión, vamos a diseñar una función que pueda ser utilizada con facilidad para estos gráficos y otros más generados con <a href="https://ggplot2.tidyverse.org">ggplot2</a> y guardados en una lista (antes hemos activado el paquete <a href="https://patchwork.data-imaginist.com">patchwork</a>). En concreto, la función crea agrupaciones de 4 gráficos (la última podrá tener menos) para presentar todos los gráficos almacenados de un modo más condensado. Hemos llamado a la función: <code>create_patchwork()</code></p>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>  </span>
<span></span>
<span><span class="co"># Función para crear agrupaciones de 2x2 con espacios en blanco si es necesario</span></span>
<span>  <span class="va">create_patchwork</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">plot_list</span><span class="op">)</span> <span class="op">{</span>   </span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">plot_list</span><span class="op">)</span>   </span>
<span>    <span class="va">full_rows</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fl">4</span>   </span>
<span>    <span class="va">remaining</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">4</span>      </span>
<span>    <span class="va">patchworks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Crear agrupaciones completas de 2x2   </span></span>
<span>    </span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">full_rows</span> <span class="op">*</span> <span class="fl">4</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">patchworks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">patchworks</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">(</span><span class="va">plot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">plot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span></span>
<span>                             <span class="op">(</span><span class="va">plot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">plot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>   <span class="op">}</span></span>
<span>    <span class="co"># Crear la última agrupación con espacios en blanco si es necesario   </span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">remaining</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>     </span>
<span>        <span class="va">last_plots</span> <span class="op">&lt;-</span> <span class="va">plot_list</span><span class="op">[</span><span class="op">(</span><span class="va">full_rows</span> <span class="op">*</span> <span class="fl">4</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span>     </span>
<span>        <span class="va">empty_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">4</span> <span class="op">-</span> <span class="va">remaining</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>                                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">last_patchwork</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="fu">patchwork</span><span class="fu">::</span><span class="va"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span>,</span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">last_plots</span>, <span class="va">empty_plots</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">patchworks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">patchworks</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">last_patchwork</span><span class="op">)</span><span class="op">)</span>   <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">patchworks</span><span class="op">)</span> <span class="op">}</span> </span></code></pre></div>
<p>Los elementos claves de la función son:</p>
<ul>
<li><p><strong><code>plot_list</code></strong>: Lista de los gráficos que se van a organizar.</p></li>
<li><p><strong><code>n</code></strong>: Número total de gráficos en <strong><code>plot_list</code></strong>.</p></li>
<li><p><strong><code>full_rows</code></strong>: Número de filas completas de 2x2 que se pueden formar (cada fila tiene 4 gráficos).</p></li>
<li><p><strong><code>remaining</code></strong>: Número de gráficos que sobran después de formar las filas completas.</p></li>
<li><p><strong><code>patchworks &lt;- list()</code></strong>: inicialización de la lista para almacenar la lista de composiciones de gráficos que se van a almacenar.</p></li>
<li><p><strong><code>seq(1, full_rows * 4, by = 4)</code></strong>: Genera una secuencia de índices para iterar sobre los gráficos en grupos de 4.</p></li>
<li>
<p>Dentro del bucle, se crean composiciones de 2x2 usando la sintaxis de <strong><code>patchwork</code></strong>:</p>
<ul>
<li>
<strong><code>(plot_list[[i]] | plot_list[[i+1]]) / (plot_list[[i+2]] | plot_list[[i+3]])</code></strong>: Combina cuatro gráficos en una disposición de 2x2.</li>
</ul>
</li>
<li><p><strong><code>patchworks &lt;- c(patchworks, list(...))</code></strong>: Añade cada nueva composición a la lista <strong><code>patchworks</code></strong>.</p></li>
<li><p><strong><code>if (remaining &gt; 0)</code></strong>: Verifica si hay gráficos restantes después de formar las filas completas.</p></li>
<li><p><strong><code>last_plots</code></strong>: Selecciona los gráficos restantes.</p></li>
<li><p><strong><code>empty_plots</code></strong>: Crea gráficos vacíos (<strong><code>ggplot() + theme_void()</code></strong>) para llenar los espacios hasta completar un grupo de 4.</p></li>
<li><p><strong><code>last_patchwork</code></strong>: Combina los gráficos restantes y los gráficos vacíos en una última composición usando <strong><code><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">patchwork::wrap_plots</a></code></strong>.</p></li>
<li><p><strong><code>patchworks &lt;- c(patchworks, list(last_patchwork))</code></strong>: Añade la última composición a la lista “patchworks”.</p></li>
<li><p><strong><code>return(patchworks)</code></strong> finaliza la ejecución de la función y devuelve la lista “<code>patchworks"</code>.</p></li>
</ul>
<p>Una vez creada la función, se pasa a nuestra lista de gráficos, “gráficos.centroides”, creando la lista de “grupos de gráficos” llamada “grupos-graficos.centroides”:</p>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Aplicar a gráficos de centroides.</span></span>
<span>  </span>
<span>   <span class="va">grupos.graficos.centroides</span> <span class="op">&lt;-</span> <span class="fu">create_patchwork</span><span class="op">(</span><span class="va">graficos.centroides</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Presentar las composiciones</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">grupos.graficos.centroides</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">grupos.graficos.centroides</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-218-1.png" width="672"></div>
<p>Hablando siempre en términos de la media (centroides), puede comprobarse cómo el grupo 1 destaca por su alto valor en el resultado y en los fondos propios, el grupo 2 por el alto margen y el alto valor de la solvencia, el tercer grupo por poseer valores discretos (pero no negativos) en las cuatro variables, el cuarto grupo por la elevada solvencia y el margen negativo, y el quinto grupo por el margen y la solvencia negativos.</p>
<p>Por otro lado, se pueden presentar en diferentes tablas las composiciones e informaciones de cada grupo. Vamos a automatizar de nuevo el proceso de generación de las tablas mediante el empleo de un <em>bucle.</em> Las diferentes tablas se irán guardando en una lista de nombre, por ejemplo, “tablascompo”:</p>
<div class="sourceCode" id="cb266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Tablas con composiciones de grupos</span></span>
<span></span>
<span>  <span class="co"># Número de tablas y lista para guardarlas</span></span>
<span></span>
<span>  <span class="va">numclusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nlevels.html">nlevels</a></span><span class="op">(</span><span class="va">originales</span><span class="op">$</span><span class="va">whatcluster_j</span><span class="op">)</span></span>
<span>  <span class="va">tablascompo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Bucle para generar las tablas</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">numclusters</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">tabla</span> <span class="op">&lt;-</span> <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">whatcluster_j</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">RES</span>, <span class="va">MARGEN</span>, <span class="va">FPIOS</span>, <span class="va">SOLVENCIA</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Método de Ward. Grupo "</span>, <span class="va">n</span>, <span class="st">"."</span><span class="op">)</span>,</span>
<span>            col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Resultado"</span>, <span class="st">"Margen"</span>,</span>
<span>                          <span class="st">"Fondos Propios"</span>, <span class="st">"Solvencia"</span><span class="op">)</span>,</span>
<span>            format.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>decimal.mark <span class="op">=</span> <span class="st">"."</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                    bootstrap_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"striped"</span>,</span>
<span>                                          <span class="st">"bordered"</span>,</span>
<span>                                          <span class="st">"condensed"</span><span class="op">)</span>,</span>
<span>                    position <span class="op">=</span> <span class="st">"center"</span>,</span>
<span>                    font_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fl">0</span>, bold <span class="op">=</span> <span class="cn">TRUE</span>, align <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span></span>
<span>      <span class="va">tablascompo</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tabla</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Presentar las tablas</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">numclusters</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tablascompo</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>Las tablas obtenidas serán:</p>
<p>Para representar los grupos gráficamente, tenemos la dificultad de contar con más de dos variables clasificadoras. Una idea es <strong>generar todas las combinaciones de variables posibles</strong>, generar los correspondientes gráficos de dispersión con los casos coloreados de modo diferente según el grupo de pertenencia, y presentar estos gráficos de modo compacto utilizando la función <code>create_patchwork()</code> que se incluyó anteriormente para hacer mediante <a href="https://patchwork.data-imaginist.com">patchwork</a>.composiciones de 2x2 gráficos.</p>
<p>Vamos a realizar la tarea de generar todos los gráficos de modo automatizado. Primero generaremos un vector con el nombre de todas las variables (excluyendo al <em>factor</em> whatcluster_j) mediante la función <code><a href="https://generics.r-lib.org/reference/setops.html">setdiff()</a></code>. Luego, crearemos una lista para ir almacenando los gráficos (lista “graficos”). Por último, calcularemos todas las combinaciones de nombres de variables posibles, con la función <code><a href="https://rdrr.io/r/utils/combn.html">combn()</a></code>, y las almacenaremos en la lista “combinaciones”. En esta función, el argumento <strong><code>simplify = FALSE</code></strong> le dice a la función que no vuelque el resultado a una matriz. En su lugar, devuelve una lista donde cada elemento de la misma es una combinación de los elementos del vector original.</p>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gráficos Variable vs Variable</span></span>
<span></span>
<span>  <span class="co"># Lista de variables excluyendo la variable no deseada</span></span>
<span>    <span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">originales</span><span class="op">)</span>, <span class="st">"whatcluster_j"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Lista para almacenar los gráficos</span></span>
<span>    <span class="va">graficos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Generar todas las combinaciones posibles de pares de variables</span></span>
<span>    <span class="va">combinaciones</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/combn.html">combn</a></span><span class="op">(</span><span class="va">variables</span>, <span class="fl">2</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>El siguiente paso consiste en utilizar un bucle para generar los gráficos de dispersión de acuerdo a las combinaciones de variables obtenidas y guardarlos en la lista “graficos”. El bucle itera tantas veces como elementos guarda la lista “combinaciones” (argumento/función <code><a href="https://rdrr.io/r/base/seq.html">seq_along()</a></code>):</p>
<div class="sourceCode" id="cb268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Bucle para crear y almacenar los gráficos</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">combinaciones</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">var1</span> <span class="op">&lt;-</span> <span class="va">combinaciones</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>      <span class="va">var2</span> <span class="op">&lt;-</span> <span class="va">combinaciones</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>      <span class="va">grafico</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">originales</span>,</span>
<span>                        map <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_.html">aes_string</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">var1</span>,</span>
<span>                                         y <span class="op">=</span> <span class="va">var2</span>,</span>
<span>                                         color <span class="op">=</span> <span class="st">"whatcluster_j"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                 <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>                 <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"GRÁFICO"</span>, <span class="va">var1</span>, <span class="st">"-"</span>, <span class="va">var2</span><span class="op">)</span>,</span>
<span>                      subtitle <span class="op">=</span> <span class="st">"Empresas eólicas"</span><span class="op">)</span> <span class="op">+</span></span>
<span>                 <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span> <span class="op">(</span><span class="va">var1</span><span class="op">)</span> <span class="op">+</span></span>
<span>                 <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span> <span class="op">(</span><span class="va">var2</span><span class="op">)</span> <span class="op">+</span></span>
<span>                 <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span> </span>
<span>      <span class="va">graficos</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"grafico_"</span>, <span class="va">var1</span>, <span class="st">"_"</span>, <span class="va">var2</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">grafico</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Una vez generados los gráficos de todas las combinaciones de variables (6 gráficos en el ejemplo), y almacenados en la lista “graficos”, se podrán reagrupar y presentar en composiciones de 2x2 mediante el empleo de la función <code>create_patchwork()</code>:</p>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Hacer agrupaciones con la función de patchworks creada anteriormente</span></span>
<span></span>
<span>    <span class="va">gruposgraficos</span> <span class="op">&lt;-</span> <span class="fu">create_patchwork</span><span class="op">(</span><span class="va">graficos</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Presentar las composiciones</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">gruposgraficos</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">gruposgraficos</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span></code></pre></div>
<p><img src="RstarS_files/figure-html/unnamed-chunk-224-1.png" width="672"><img src="RstarS_files/figure-html/unnamed-chunk-224-2.png" width="672"></p>
<p>De los gráficos anteriores, pueden extraerse algunas conclusiones. Por ejemplo, en los tres primeros gráficos, destaca la posición de la única empresa que forma el grupo 1 (Holding de Negocios de Gas, S. L.), sobre todo en cuanto al resultado RES (eje x). En este sentido, mención especial merece el gráfico 2 (RES-FPIOS), debido a la especial situación de esta empresa en cuanto a Fondos Propios (FPIOS), lo que se aprecia también en los gráficos 4 y 6. El grupo 4 también está constituido únicamente por una empresa (WPD Wind Investment S. L.), si bien en los diferentes gráficos no muestra una separación tan notable con respecto al resto de empresas y grupos. Tan solo en los gráficos 1, 4 y 5 destaca, debido a la influencia de la variable de margen de beneficio (MARGEN). El grupo 5 es el tercer y último grupo constituido por una única empresa (Sargon Energías S. L. U.). En este caso, su comportamiento destaca en los mismos gráficos que el caso anterior, debido también a su margen de beneficio (MARGEN), visiblemente por debajo del valor presente en el resto de empresas. En cuanto a los grupos constituidos por más de una empresa, las empresas de ambos grupos se muestran relativamente próximas, pudiéndose concluir que las empresas del grupo 2 tienen, en general, mayor volumen de fondos propios (FPIOS) y coeficiente de solvencia (SOLVENCIA) que las del grupo 3; mientras que en cuanto a margen (MARGEN) y resultado (RES) muestran, globalmente, valores próximos.</p>
</div>
<div id="métodos-de-agrupación-no-jerárquicos." class="section level2" number="7.3">
<h2>
<span class="header-section-number">7.3</span> Métodos de agrupación no-jerárquicos.<a class="anchor" aria-label="anchor" href="#m%C3%A9todos-de-agrupaci%C3%B3n-no-jer%C3%A1rquicos."><i class="fas fa-link"></i></a>
</h2>
<p>Dentro del análisis clúster, los métodos de agrupación no-jerárquicos se utilizan en casos en los que hay un elevado número de casos que clasificar. Son especialmente útiles cuando nuestro objetivo pasa por crear grupos que definan <strong>una tipología de casos o individuos</strong>, más que clasificar casos o individuos concretos. En definitiva, identificar subpoblaciones a partir de una muestra. Por eso es conveniente, previamente, detectar los <em>outliers</em> y, en su caso, eliminarlos; ya que podrían distorsionar las características de los grupos debido a la sensibilidad de los algoritmos a la presencia de casos atípicos.</p>
<p>Una diferencia clave con respecto a los métodos jerárquicos es que <strong>es necesario decidir <em>a priori</em> el número de conclomerados</strong> o grupos de casos a formar. Por otro lado, son métodos más eficientes, y permiten el traslado de casos de unos grupos a otros.</p>
<p>Aunque existen otros métodos, la técnica no-jerárquica más común es la de <strong>k-medias</strong>. Este es un método iterativo. Se establece un <em>centroide</em> inicial (“semilla”) para cada uno de los k grupos que se quieren crear, y se van asignando a cada grupo los casos que se sitúen más cerca de su centro. Una vez asignados los casos, se recalculan los <em>centroides</em> de los grupos, y se repite el proceso en una nueva iteración. El procedimiento termina cuando el algoritmo encuentra la solución convergente (estable). Precisamente, la elección de las “semillas” iniciales es otro de las debilidades que presenta el método, ya que de ello puede depender la obtención de soluciones diferentes.</p>
<p>¿Cómo fijar el <strong>número de grupos o conglomerados a formar</strong>? Hay ocasiones en que las que el investigador establecerá un número que le sea manejable o útil según los objetivos que persiga. Si esto no es así, y no se tiene claro el número de grupos a construir, se podrá optar por probar con varios números, y evaluar las soluciones obtenidas. También puede ayudar el realizar previamente un análisis jerárquico para estudiar el dendograma. Además, existen algoritmos, como <em>NbClust</em> en R, que sugieren un número de grupos en función de una batería de pruebas presentes en la literatura.</p>
<p>La segunda cuestión clave es <strong>cómo determinar las “semillas”</strong> o centroides iniciales. Una opción es generar las semillas de modo aleatorio, aunque no es un método muy conveniente. De hecho, cada vez que se aplicara el algoritmo de <em>k-medias</em>, podría obtenerse una solución diferente. Otra alternativa es la fijación de las “semillas” por parte del investigador. Una idea, en este sentido, es hacer un <em>clúster jerárquico</em> previo, y tomar los <em>centroides</em> de la solución final como “semillas” de k-medias. Otra posibilidad interesante es aplicar el método del <em>centroide más lejano</em>: se fija el primer centroide al azar, pero luego el 2º centroide coincidirá con el punto de datos más alejado de él. En general, el jº centroide coincidirá con el punto cuya distancia mínima a los centroides precedentes sea mayor. Se pretende que los centroides estén bien separados unos de otros. Una versión mejorada es el método <em>k-medias++</em>.</p>
<p>Para nuestro ejemplo práctico, vamos a volver a utilizar como variables clasificadoras las del ejemplo desarrollado para los métodos jerárquicos; pero esta vez para una muestra de 350 empresas de generación de electricidad mediante tecnología eólica. Estas variables son, de nuevo, resultado del ejercicio (RES), margen de beneficio (MARGEN), fondos propios (FPIOS), y solvencia (SOLVENCIA). Con base en ellas, queremos <strong>establecer una serie de perfiles o tipologías</strong> distintas de las empresas que componen el sector.</p>
<p>Trabajaremos, como en el ejemplo de clúster jerarquizado, en el proyecto llamado “cluster”. Vamos a ir a la carpeta del proyecto y vamos a guardar en ella los dos archivos de esta práctica: un archivo de Microsoft® Excel® llamado “<a href="https://docs.google.com/spreadsheets/d/1Brtu_58lcfXL5ZTeOi9-xlxy7S9NfuxB/edit?usp=sharing&amp;ouid=115375878280465826079&amp;rtpof=true&amp;sd=true">eolica_350.xlsx</a>” y un <em>script</em> denominado “<a href="https://drive.google.com/file/d/1nOBc99SsMKYACitAVRD0nnpP8q-8FqJZ/view?usp=sharing">kmedias_eolica.R</a>”. Si abrimos el archivo de Microsoft® Excel®, comprobaremos que se compone de tres hojas. La primera muestra un aviso sobre la utilización de los datos, la segunda el nombre y definición de las variables disponibles, y la tercera (hoja “Datos”) guarda los datos que debemos importar desde R-Studio. Estos datos se corresponden con diferentes variables económico-financieras de 350 empresas productoras de electricidad mediante generación eólica.</p>
<p>La primera parte del <em>script</em> se ocupa de importar los datos de la hoja de cálculo, limpiando previamente la memoria (<em>Environment</em>) de posibles objetos almacenados en sesiones anteriores:</p>
<div class="sourceCode" id="cb270"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CLUSTER de k-medias productores eolicos. Disculpad la falta de tildes!!!!</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># DATOS</span></span>
<span></span>
<span>  <span class="co"># Importando</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span></span>
<span>    <span class="va">eolicos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="st">"eolica_350.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"Datos"</span>,</span>
<span>                          na <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"n.d."</span>, <span class="st">"s.d."</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">eolicos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">eolicos</span>, row.names <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span> <span class="op">(</span><span class="va">eolicos</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      MARGEN           SOLVENCIA          COM                FJUR          
##  Min.   :-4124.22   Min.   :-83.97   Length:350         Length:350        
##  1st Qu.:   19.15   1st Qu.: 14.92   Class :character   Class :character  
##  Median :   42.93   Median : 38.78   Mode  :character   Mode  :character  
##  Mean   :   32.60   Mean   : 40.11                                        
##  3rd Qu.:   64.77   3rd Qu.: 68.16                                        
##  Max.   : 1790.12   Max.   : 99.78                                        
## 
##       ING               NCOMP            RES                ACTIVO         
##  Min.   :    69.7   Min.   :    0   Min.   :-16107.21   Min.   :     36.8  
##  1st Qu.:   822.3   1st Qu.:    2   1st Qu.:    48.58   1st Qu.:   3569.9  
##  Median :  4060.7   Median :   72   Median :   751.07   Median :  17239.6  
##  Mean   :  8985.4   Mean   : 1526   Mean   :  2616.99   Mean   :  50776.5  
##  3rd Qu.:  8408.4   3rd Qu.:  398   3rd Qu.:  3119.00   3rd Qu.:  41660.9  
##  Max.   :364989.0   Max.   :72434   Max.   : 78290.00   Max.   :2429299.0  
##                     NA's   :1       NA's   :1                              
## 
##      FPIOS               RENECO            RENFIN            LIQUIDEZ        
##  Min.   : -51817.4   Min.   :-85.351   Min.   :-687.418   Min.   :   0.0070  
##  1st Qu.:    635.1   1st Qu.:  3.169   1st Qu.:   7.804   1st Qu.:   0.7738  
##  Median :   3421.8   Median :  9.948   Median :  26.208   Median :   1.8440  
##  Mean   :  20814.8   Mean   : 15.190   Mean   :  70.773   Mean   :   9.1875  
##  3rd Qu.:  11814.0   3rd Qu.: 22.402   3rd Qu.:  56.279   3rd Qu.:   3.8505  
##  Max.   :1382020.0   Max.   :102.130   Max.   :6788.328   Max.   :1367.0610  
## 
##     APALANCA            AUTOFIN         DIMENSION           AUTOFINA        
##  Min.   : -7016.77   Min.   :     -3   Length:350         Length:350        
##  1st Qu.:     2.99   1st Qu.:      0   Class :character   Class :character  
##  Median :    48.62   Median :      1   Mode  :character   Mode  :character  
##  Mean   :   974.23   Mean   :  15120                                        
##  3rd Qu.:   248.31   3rd Qu.:      4                                        
##  Max.   :177381.90   Max.   :4486914                                        
##                      NA's   :53                                             
## 
##     RENTALIQ         VALORACION       
##  Min.   :-226.188   Length:350        
##  1st Qu.:   5.668   Class :character  
##  Median :  15.148   Mode  :character  
##  Mean   :  31.717                     
##  3rd Qu.:  30.400                     
##  Max.   :2264.254</code></pre>
<p>Podemos observar cómo, en el <em>Environment,</em> ya aparece un objeto. Este objeto es una estructura de datos tipo <em>data frame</em>, se llama “eolicos” y contiene 18 columnas, una por cada una de las variables almacenadas en el archivo de Microsoft® Excel®. R consideró la primera columna de la hoja de Excel (NOMBRE) como una variable de tipo cualitativo o atributo (por lo que había 19 columnas); pero, al no ser una variable, sino el nombre de los casos o filas (empresas), redefinimos nuestro <em>data frame</em> diciéndole que esa primera columna contenía los nombres de los casos (filas).</p>
<p>En el análisis solo vamos a considerar como variables clasificadoras para construir los grupos o conglomerados las variables RES, MARGEN, FPIOS y SOLVENCIA. Por ello, crearemos con ellas un nuevo <em>data frame</em> llamado “originales” a partir de la función <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> del paquete <a href="https://dplyr.tidyverse.org">dplyr</a>:</p>
<pre><code>##       RES                MARGEN             FPIOS             SOLVENCIA     
##  Min.   :-16107.21   Min.   :-4124.22   Min.   : -51817.4   Min.   :-83.97  
##  1st Qu.:    48.58   1st Qu.:   19.15   1st Qu.:    635.1   1st Qu.: 14.92  
##  Median :   751.07   Median :   42.93   Median :   3421.8   Median : 38.78  
##  Mean   :  2616.99   Mean   :   32.60   Mean   :  20814.8   Mean   : 40.11  
##  3rd Qu.:  3119.00   3rd Qu.:   64.77   3rd Qu.:  11814.0   3rd Qu.: 68.16  
##  Max.   : 78290.00   Max.   : 1790.12   Max.   :1382020.0   Max.   : 99.78  
##  NA's   :1</code></pre>
<p>El siguiente paso consiste en localizar los posibles <strong><em>missing values</em></strong>, ya que para realizar el análisis es necesario que todos los casos posean dato para todas las variables originales. Para tener una idea general, se puede utilizar la función <code><a href="https://docs.ropensci.org/visdat/reference/vis_miss.html">vis_miss()</a></code> del paquete <a href="https://docs.ropensci.org/visdat/">visdat</a>, que nos localizará gráficamente los <em>missing values</em> de las diferentes variables, y calculará el porcentaje de casos que supone, con respecto al total de observaciones:</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Identificando missing values.</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/visdat/">visdat</a></span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://docs.ropensci.org/visdat/reference/vis_miss.html">vis_miss</a></span><span class="op">(</span><span class="va">originales</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-228-1.png" width="672"></div>
<p>Una vez puesta de manifiesto la existencia de un <em>missing value</em>, localizaremos el caso concreto que lo contiene aplicando la función <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> de <a href="https://dplyr.tidyverse.org">dplyr</a>. El caso es la empresa “Desarrollos Eólicos de Teruel S. L.”:</p>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">RES</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">MARGEN</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">FPIOS</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">SOLVENCIA</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">RES</span>, <span class="va">MARGEN</span>, <span class="va">FPIOS</span>, <span class="va">SOLVENCIA</span><span class="op">)</span>  </span></code></pre></div>
<pre><code>##                                  RES MARGEN   FPIOS SOLVENCIA
## Desarrollos Eolicos de Teruel SL  NA      0 18890.1    37.285</code></pre>
<p>Sabemos que ante la existencia de <em>missing values</em>, se puede actuar de varios modos. Por ejemplo, <strong>se puede intentar obtener por otro canal de información el conjunto de valores</strong> que no están disponibles, <strong>o recurrir a alguna estimación</strong>. En caso de que esto sea difícil, se puede optar por <strong>eliminar</strong> estos casos, en especial cuando representan un porcentaje muy reducido respecto al total de casos. En nuestro ejemplo, supondremos que hemos optado por esta última vía, y eliminaremos este caso con otro filtro:</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="va">originales</span> <span class="op">&lt;-</span> <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">RES</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">MARGEN</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">FPIOS</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>             <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">SOLVENCIA</span><span class="op">)</span><span class="op">)</span>  </span></code></pre></div>
<p>El <em>data frame</em> “originales” pasa a tener 349 observaciones, ya que se ha descartado a la empresa a la que le faltaba el dato del resultado del ejercicio (RES).</p>
<p>El siguiente paso es la <strong>identificación de <em>outliers</em>.</strong> Para realizar este proceso, y dado que en nuestro análisis contamos con 4 variables, primero “resumiremos” el valor que toman dichas variables para cada caso, mediante el cálculo de la <em>distancia de Mahalanobis</em>. De hecho, las distancias de los diferentes casos se almacenarán en una nueva variable, a la que llamaremos MAHALANOBIS, que se incorporará al <em>data frame</em> “originales” por medio de la función <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> de <a href="https://dplyr.tidyverse.org">dplyr</a>, y la función <code><a href="https://rdrr.io/r/stats/mahalanobis.html">mahalanobis()</a></code>. Recordemos que, en los diferentes argumentos de esta función, el punto “.” hace referencia al <em>data frame</em> que está delante del operador pipe (<code>%&gt;%</code>):</p>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Identificando outliers.</span></span>
<span></span>
<span>    <span class="va">originales</span> <span class="op">&lt;-</span> <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>MAHALANOBIS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mahalanobis.html">mahalanobis</a></span><span class="op">(</span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>                                        center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>                                        cov<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Una vez creada la variable MAHALANOBIS, se estudia la existencia en sus valores de <em>outliers</em> mediante la construcción de un diagrama de caja o <em>boxplot</em> (para una mejor visión de la “caja”, emplearemos la escala logarítmica):</p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">originales</span>, map <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"DISTANCIA DE MAHALANOBIS"</span>, subtitle <span class="op">=</span> <span class="st">"Empresas eólicas"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"ln(MAHALANOBIS)"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-232-1.png" width="672"></div>
<p>En el gráfico se observa que existen, por encima de la caja, varios outliers. Para identificarlos de modo concreto, hemos de calcular los cuartiles primero y tercero de la variable MAHALANOBIS y pasar el correspondiente filtro:</p>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="va">Q1M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span> <span class="op">(</span><span class="va">originales</span><span class="op">$</span><span class="va">MAHALANOBIS</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">Q3M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span> <span class="op">(</span><span class="va">originales</span><span class="op">$</span><span class="va">MAHALANOBIS</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span> <span class="op">&gt;</span> <span class="va">Q3M</span> <span class="op">+</span> <span class="fl">1.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span><span class="op">)</span> <span class="op">|</span></span>
<span>             <span class="va">MAHALANOBIS</span> <span class="op">&lt;</span> <span class="va">Q1M</span> <span class="op">-</span> <span class="fl">1.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span><span class="op">)</span></span></code></pre></div>
<pre><code>##                                                                        MAHALANOBIS
## EDP Renovables España SLU                                                66.135161
## Naturgy Renovables SLU                                                  154.403714
## Norvento Estelo SL.                                                      11.646717
## Acciona Eolica de Castilla LA Mancha SL                                   8.831525
## Compañia Eolica Aragonesa SA                                              4.361055
## CYL Energia Eolica SL                                                     4.538600
## Desarrollo de Energias Renovables de Navarra SA                           5.958512
## Molinos DEL Cidacos SA                                                    5.395054
## Enerfin Enervento SL.                                                    20.615939
## Danta de Energias SA                                                      4.659270
## Viesgo Renovables SL.                                                    13.406912
## Desarrollo Eolico LAS Majas XIX SL.                                       4.893162
## Alectoris Energia Sostenible 6 SL.                                        5.831212
## Green Capital Power SL                                                   60.334525
## Elawan Energy SL.                                                        14.892019
## OW Offshore SL                                                           75.843770
## Compañia Integral de Energias Renovables de Zaragoza Sociedad Limitada    5.206170
## Desarrollos Eolicos DEL SUR de Europa Sociedad Limitada.                  4.592127
## Fuerzas Energeticas DEL SUR de Europa XV SL.                              4.636275
## Fuerzas Energeticas DEL SUR de Europa XXI SL.                             5.386255
## Parque Eolico de Adraño SL                                                5.127652
## Parque Eolico de A Ruña SL                                                6.457498
## Repsol Renovables S.A.U.                                                181.564290
## Desarrollo Eolico de LA Muga SL                                           4.637771
## Parque Eolico de Virxe DO Monte SL                                        5.360384
## Parque Eolico Tahuna S.L.                                                12.646108
## Alabe Proyectos Eolicos SA.                                               7.961243
## Parsona Corporacion SL.                                                   4.508346
## Parque Eolico Jaufil SL.                                                  5.262772
## Parque Eolico LAS Lomas de Lecrin S.L.                                    4.442394
## WPD Wind Investment SL.                                                   8.780323
## Energia Y Recursos Ambientales Internacional SL                           8.703097
## Bluefloat Energy International SL.                                      267.082180
## Plafovolt SL                                                             12.144060
## Minicentrales Bouza Vella SL                                             50.866827</code></pre>
<p>El filtro anterior nos ofrece un listado de 35 empresas consideradas <em>outliers</em>. Estas empresas cuentan con un valor atípico en la variable MAHALANOBIS lo que, a su vez, implica que seguramente posean valores atípicos en una o varias de las variables originales (RES, MARGEN, FPIOS, SOLVENCIA)<strong>. La presencia de <em>outliers</em> puede hacer que se distorsione el proceso de obtención de grupos de casos a partir de los cuáles se extraen perfiles o tipologías de empresas</strong>, debido a su influencia sobre el cálculo de los centroides de los grupos. Por tanto, procederemos a eliminar del análisis estas empresas, mediante el paso del correspondiente filtro, y la creación de un nuevo <em>data frame</em> sin casos outliers, al que llamaremos, por ejemplo, “originales_so”. Por último, borramos la variable MAHALANOBIS del <em>data frame “</em>originales”, puesto que ya ha cumplido la función de localizar los casos atípicos:</p>
<div class="sourceCode" id="cb281"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="va">originales_so</span> <span class="op">&lt;-</span> <span class="va">originales</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span> <span class="op">&lt;=</span> <span class="va">Q3M</span> <span class="op">+</span> <span class="fl">1.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>                             <span class="va">MAHALANOBIS</span> <span class="op">&gt;=</span> <span class="va">Q1M</span> <span class="op">-</span> <span class="fl">1.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">MAHALANOBIS</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">originales_so</span> <span class="op">&lt;-</span> <span class="va">originales_so</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">MAHALANOBIS</span><span class="op">)</span></span></code></pre></div>
<p>Una vez preparados los datos, vamos a proceder a aplicar la técnica de formación de conglomerados no-jerárquica de k-medias. Primeramente, y puesto que se basa en el cálculo de las distancias euclídeas entre casos, procederemos a tipificar los valores de las variables, utilizando la función <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code>, y creando el data frame “zoriginales_so”:</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CLUSTER K-MEDIAS CON VARIABLES ORIGINALES.</span></span>
<span></span>
<span>  <span class="co"># Tipificando variables</span></span>
<span></span>
<span>    <span class="va">zoriginales_so</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">originales_so</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span> <span class="op">(</span><span class="va">zoriginales_so</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       RES              MARGEN             FPIOS           SOLVENCIA      
##  Min.   :-3.0216   Min.   :-6.41731   Min.   :-0.8852   Min.   :-2.2102  
##  1st Qu.:-0.6348   1st Qu.:-0.33447   1st Qu.:-0.5943   1st Qu.:-0.8322  
##  Median :-0.3982   Median : 0.08039   Median :-0.3900   Median :-0.1216  
##  Mean   : 0.0000   Mean   : 0.00000   Mean   : 0.0000   Mean   : 0.0000  
##  3rd Qu.: 0.4271   3rd Qu.: 0.48147   3rd Qu.: 0.1449   3rd Qu.: 0.8381  
##  Max.   : 3.8714   Max.   : 7.20005   Max.   : 7.2526   Max.   : 1.8874</code></pre>
<p>Una cuestión clave es la determinación previa del número de grupos a formar. Si no se tiene decidido un número de conglomerados <em>a priori</em> como consecuencia del interés o de los objetivos de la propia investigación, se puede recurrir como orientación a algún paquete de R que propone el número de grupos a formar. Uno de estos paquetes es <a href="https://sites.google.com/site/malikacharrad/research/nbclust-package">NbClust</a>, y en concreto su función <code><a href="https://rdrr.io/pkg/NbClust/man/NbClust.html">NbClust()</a></code>:</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Numero de grupos</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sites.google.com/site/malikacharrad/research/nbclust-package">NbClust</a></span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/NbClust/man/NbClust.html">NbClust</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">zoriginales_so</span>,</span>
<span>                                     min.nc <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                     max.nc <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                                     method <span class="op">=</span> <span class="st">"kmeans"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="RstarS_files/figure-html/unnamed-chunk-236-1.png" width="672"><img src="RstarS_files/figure-html/unnamed-chunk-236-2.png" width="672"></p>
<div class="sourceCode" id="cb285"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="va">start_line</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"* Among all indices:"</span>, <span class="va">result</span><span class="op">)</span></span>
<span>    <span class="va">end_line</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"* According to"</span>, <span class="va">result</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">[</span><span class="va">start_line</span><span class="op">:</span><span class="va">end_line</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "* Among all indices:                                                " 
##  [2] "* 4 proposed 2 as the best number of clusters "                       
##  [3] "* 10 proposed 3 as the best number of clusters "                      
##  [4] "* 1 proposed 4 as the best number of clusters "                       
##  [5] "* 1 proposed 5 as the best number of clusters "                       
##  [6] "* 4 proposed 6 as the best number of clusters "                       
##  [7] "* 2 proposed 8 as the best number of clusters "                       
##  [8] "* 1 proposed 10 as the best number of clusters "                      
##  [9] ""                                                                     
## [10] "                   ***** Conclusion *****                            "
## [11] " "                                                                    
## [12] "* According to the majority rule, the best number of clusters is  3 "</code></pre>
<p>La función <code><a href="https://rdrr.io/pkg/NbClust/man/NbClust.html">NbClust()</a></code> aplica una batería de entre 20-30 medidas e indicadores recogidos en la literatura científica desarrollados para determinar el número óptimo de grupos o clústeres a formar, y ofrece de modo los resultados. Precisamente, en el código anterior, se almacena el output que ofrece la función en el objeto “result”, luego se elige de entre todo ese <em>output</em> el texto donde se ofrece el resumen de los resultados (concretando la línea inicial y la final mediante la función <code><a href="https://rdrr.io/r/base/grep.html">grep()</a></code>), y se ofrece ese resumen. Según el mismo, la mayoría de los índices e indicadores proponen 3 grupos como la segmentación más adecuada.</p>
<p>Una vez decidido el número de grupos (en el ejemplo, 3), se pasa tal número a una constante “k” para manejarlo con más comodidad en el resto del código. Después, se aplica el método de <strong><em>k-medias</em></strong>, en la versión de la función <code><a href="https://rdrr.io/pkg/ClusterR/man/KMeans_rcpp.html">KMeans_rcpp()</a></code> del paquete <a href="https://github.com/mlampros/ClusterR">ClusterR</a>, que permite obtener las “semillas” (centroides iniciales) mediante el algoritmo <em>kmeans++</em>, que ofrece buenos resultados frente a otras posibilidades de obtención de “semillas”, como la generación puramente aleatoria. La función <code><a href="https://rdrr.io/r/base/Random.html">set.seed()</a></code> fija la secuencia de generación de números aleatorios, de modo que, si se ejecuta varias veces el mismo código, se obtendrá la misma solución:</p>
<div class="sourceCode" id="cb287"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">3</span>  <span class="co"># poner aquí número de grupos decidido!!!!</span></span>
<span></span>
<span>  <span class="co"># Aplicando k-means con inicializacion kmeans++</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="https://github.com/mlampros/ClusterR">ClusterR</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cluster_k</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/ClusterR/man/KMeans_rcpp.html">KMeans_rcpp</a></span> <span class="op">(</span><span class="va">zoriginales_so</span>,</span>
<span>                           clusters <span class="op">=</span> <span class="va">k</span>,</span>
<span>                           num_init <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                           max_iters <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                           initializer <span class="op">=</span> <span class="st">"kmeans++"</span><span class="op">)</span></span></code></pre></div>
<p>En la función <code><a href="https://rdrr.io/pkg/ClusterR/man/KMeans_rcpp.html">KMeans_rcpp()</a></code>, el primer argumento es el <em>data frame</em> con las variables clasificadoras (en sus versiones tipificadas). El segundo es el número de clústeres o grupos a obtener (que lo hemos asignado anteriormente al parámetro “<strong>k</strong>”). El tercero, <code>num_init =</code>, es el número de veces que se repite el procedimiento a fin de retener la mejor solución. <code>Max_iters =</code> fija el máximo de iteraciones del procedimiento de k<em>-medias</em> hasta obtener una solución estable. <code>Initializer =</code> define el método de obtención de las semillas (en nuestro caso, <em>k-means++</em>). La solución final se guarda en el objeto “cluster_k”, como se puede apreciar en el <em>Environment</em>.</p>
<p>Dentro de la solución, el vector con el grupo de pertenencia de cada empresa se obtiene con el elemento “$clusters”. Conviene guardar ese vector como factor. En concreto, se guardará como el factor <strong>“whatcluster_k”</strong>, integrado dentro del <em>data frame</em> “originales_so”:</p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">originales_so</span><span class="op">$</span><span class="va">whatcluster_k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">cluster_k</span><span class="op">$</span><span class="va">clusters</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">originales_so</span><span class="op">)</span></span></code></pre></div>
<pre><code>##       RES               MARGEN            FPIOS         
##  Min.   :-6521.00   Min.   :-297.14   Min.   : -3194.0  
##  1st Qu.:   63.34   1st Qu.:  21.33   1st Qu.:   691.8  
##  Median :  716.01   Median :  43.05   Median :  3420.0  
##  Mean   : 1814.51   Mean   :  38.84   Mean   :  8628.7  
##  3rd Qu.: 2992.77   3rd Qu.:  64.05   3rd Qu.: 10564.2  
##  Max.   :12494.11   Max.   : 415.80   Max.   :105490.0  
## 
##    SOLVENCIA      whatcluster_k
##  Min.   :-25.66   1: 59        
##  1st Qu.: 16.52   2:158        
##  Median : 38.28   3: 97        
##  Mean   : 42.00                
##  3rd Qu.: 67.66                
##  Max.   : 99.78</code></pre>
<p>A continuación vamos a <strong>caracterizar los grupos</strong> formados en función de las medias de las variables originales (coordenadas de los centroides). Así, se podrán mostrar en pantalla las medias de cada grupo de las distintas variables originales, usando las funciones <code>by_group()</code> y <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> de <a href="https://dplyr.tidyverse.org">dplyr</a>. Los decimales se ajustarán utilizando la función <code><a href="https://rdrr.io/r/base/Round.html">round()</a></code>. Toda la información se asigna al <em>data frame</em> “tablamedias”, para poder posteriormente representado en una tabla mediante las facilidades que ofrecen los paquetes <a href="https://yihui.org/knitr/">knitr</a> y <a href="http://haozhu233.github.io/kableExtra/">kableExtra</a>:</p>
<div class="sourceCode" id="cb290"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CARACTERIZANDO GRUPOS FORMADOS</span></span>
<span>  </span>
<span>  <span class="co"># Tabla con centroides de grupos.</span></span>
<span></span>
<span>    <span class="va">tablamedias</span> <span class="op">&lt;-</span> <span class="va">originales_so</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">whatcluster_k</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">whatcluster_k</span><span class="op">)</span>,</span>
<span>                                        Resultado <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">RES</span><span class="op">)</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>                                        Margen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">MARGEN</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                        Fondos_Propios <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">FPIOS</span><span class="op">)</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>                                        Solvencia <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">SOLVENCIA</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span></span>
<span>    <span class="va">knitr.table.format</span> <span class="op">=</span> <span class="st">"html"</span></span>
<span></span>
<span>    <span class="va">tablamedias</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>format <span class="op">=</span> <span class="va">knitr.table.format</span>,</span>
<span>            caption <span class="op">=</span> <span class="st">"Método de k-medias. 3 grupos. Medias de variables"</span>,</span>
<span>            col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Clúster"</span>, <span class="st">"Observaciones"</span>, <span class="st">"Resultado"</span>, <span class="st">"Margen"</span>,</span>
<span>                      <span class="st">"Fondos Propios"</span>, <span class="st">"Solvencia"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                    bootstrap_options <span class="op">=</span> <span class="st">"striped"</span>, <span class="st">"bordered"</span>, <span class="st">"condensed"</span>,</span>
<span>                    position <span class="op">=</span> <span class="st">"center"</span>,</span>
<span>                    font_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fl">0</span>, bold<span class="op">=</span> <span class="cn">T</span>, align <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">tablamedias</span><span class="op">)</span>, bold<span class="op">=</span> <span class="cn">F</span>, align <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-striped" style="font-size: 11px; width: auto !important; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-241">Table 7.3: </span><span id="tab:unnamed-chunk-241">Table 7.4: </span>Método de k-medias. 3 grupos. Medias de variables
</caption>
<thead><tr>
<th style="text-align:left;font-weight: bold;text-align: center;">
Clúster
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Observaciones
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Resultado
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Margen
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Fondos Propios
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Solvencia
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;text-align: center;">
1
</td>
<td style="text-align:right;text-align: center;">
59
</td>
<td style="text-align:right;text-align: center;">
6035
</td>
<td style="text-align:right;text-align: center;">
68.85
</td>
<td style="text-align:right;text-align: center;">
28311
</td>
<td style="text-align:right;text-align: center;">
57.76
</td>
</tr>
<tr>
<td style="text-align:left;text-align: center;">
2
</td>
<td style="text-align:right;text-align: center;">
158
</td>
<td style="text-align:right;text-align: center;">
708
</td>
<td style="text-align:right;text-align: center;">
18.07
</td>
<td style="text-align:right;text-align: center;">
3745
</td>
<td style="text-align:right;text-align: center;">
17.88
</td>
</tr>
<tr>
<td style="text-align:left;text-align: center;">
3
</td>
<td style="text-align:right;text-align: center;">
97
</td>
<td style="text-align:right;text-align: center;">
1050
</td>
<td style="text-align:right;text-align: center;">
54.42
</td>
<td style="text-align:right;text-align: center;">
4612
</td>
<td style="text-align:right;text-align: center;">
71.70
</td>
</tr>
</tbody>
</table></div>
<p>Obviamente, también se podrían comparar las medias de los grupos, para cada variable, con un gráfico de barras. El código es el siguiente:</p>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Gráficos de centroides</span></span>
<span></span>
<span>    <span class="co"># Vector de nombre de variables excluyendo la variable no deseada</span></span>
<span>      <span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tablamedias</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"whatcluster_k"</span>, <span class="st">"obs"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Lista para almacenar los gráficos</span></span>
<span>      <span class="va">graficos.centroides</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Bucle para crear y almacenar los gráficos</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">variables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">var1</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>        <span class="va">grafico</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span> <span class="va">tablamedias</span>,</span>
<span>                     map <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_.html">aes_string</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">var1</span>, x <span class="op">=</span> <span class="st">"whatcluster_k"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>,</span>
<span>                 colour <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>                 fill <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>                 alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">var1</span>, <span class="st">". Media por grupos."</span><span class="op">)</span>,</span>
<span>                subtitle <span class="op">=</span> <span class="st">"Empresas eólicas"</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span> <span class="op">(</span><span class="st">"Grupo"</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="va">var1</span><span class="op">)</span></span>
<span>        <span class="va">graficos.centroides</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"grafico_"</span>, <span class="va">var1</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">grafico</span></span>
<span>      <span class="op">}</span>       </span></code></pre></div>
<p>Para hacer composiciones de 4 gráficos (que en este caso será solo una, dado que hemos almacenado en la lista “graficos.centroides” 4 elementos correspondientes a las 4 variables clasificadoras), volveremos a utilizar la función <code>create_patchwork()</code>, que ya se mostró en el ejemplo de clúster jerárquico. De nuevo se incluye su código y se aplica a la lista de gráficos “graficos.centroides”:</p>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Función para crear agrupaciones de 2x2 con espacios en blanco si necesario</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span> <span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>    </span>
<span></span>
<span>    <span class="va">create_patchwork</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">plot_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">plot_list</span><span class="op">)</span></span>
<span>      <span class="va">full_rows</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fl">4</span></span>
<span>      <span class="va">remaining</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">4</span></span>
<span>  </span>
<span>    <span class="va">patchworks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="co"># Crear agrupaciones completas de 2x2</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">full_rows</span> <span class="op">*</span> <span class="fl">4</span>, by <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>           <span class="va">patchworks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">patchworks</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">(</span><span class="va">plot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">plot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span></span>
<span>                           <span class="op">(</span><span class="va">plot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">plot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>  </span>
<span>    <span class="co"># Crear la última agrupación con espacios en blanco si es necesario</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">remaining</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">last_plots</span> <span class="op">&lt;-</span> <span class="va">plot_list</span><span class="op">[</span><span class="op">(</span><span class="va">full_rows</span> <span class="op">*</span> <span class="fl">4</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">]</span></span>
<span>        <span class="va">empty_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">4</span> <span class="op">-</span> <span class="va">remaining</span><span class="op">)</span>,</span>
<span>                              <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">last_patchwork</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="fu">patchwork</span><span class="fu">::</span><span class="va"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span>,</span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">last_plots</span>, <span class="va">empty_plots</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">patchworks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">patchworks</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">last_patchwork</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>  </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">patchworks</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Aplicar función a gráficos de centroides.</span></span>
<span>    <span class="va">grupos.graficos.centroides</span> <span class="op">&lt;-</span> <span class="fu">create_patchwork</span><span class="op">(</span><span class="va">graficos.centroides</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Presentar las composiciones</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">grupos.graficos.centroides</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">grupos.graficos.centroides</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span></code></pre></div>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-243-1.png" width="672"></div>
<p>La lista “grupos.graficos.centroides” almacena las composiciones de 4 (o menos) gráficos generadas. En este ejemplo, solo tiene un elemento, que es mostrado al ejecutar el bucle de presentación de composiciones.</p>
<p>Por medio de los gráficos se pueden establecer algunas conclusiones, comparando las medias de las variables para cada grupo de casos formado (coordenadas de los centroides). Por ejemplo, el grupo 1 destaca por tener, en media, un resultado y unos fondos propios muy superiores a los del resto de grupos. En cuanto a la solvencia, también tiene en media el mayor valor, aunque la diferencia no parece tan pronunciada con respecto al grupo 3. El grupo 2 se caracteriza por tener, en media, los valores inferiores en las 4 variables clasificadoras, siempre de un modo que se antoja muy pronunciado. Por último, el grupo 3 tiene, en media, el mayor valor de solvencia y, en cuanto al margen, se sitúa relativamente cerca del margen medio del grupo 1.</p>
<p>El análisis gráfico anterior se puede complementar de un modo estadítico, a fin de verificar si las diferencias observadas entre los valores medios de los grupos, para cada variable, son significativas. Para ello, y teniendo en cuenta que los grupos se pueden considerar submuestras que representan a subpoblaciones, se puede aplicar alguna prueba de comparaciones múltiples de las medias de los grupos formados, de modo que se pueda confirmar, para cierta significación estadística (usualmente 0,05), <strong>si las diferencias en las medias de los grupos para cada variable son estadísticamente relevantes</strong> (significativas) o no.</p>
<p>Una prueba clásica para llevar a cabo esta tarea es aplicar el <em>test de comparaciones múltiples de Tuckey</em>. No obstante, y dado que esta prueba requiere del cumplimiento de ciertos requisitos previos (normalidad de los grupos, varianzas homogéneas); hemos optado por la <strong><em>prueba robusta de Kruskal-Wallis</em>.</strong> Para cada una de las variable originales, realizaremos un gráfico múltiple de diagramas de caja, y procederemos a mostrar los resultados de la prueba.</p>
<p>En primer lugar, vamos a definir el vector con el nombre de las variables que entran en el análisis (vector “variables”), e inicializaremos las listas para guardar los gráficos y los resultados de la prueba para cada variable (“graficos_kw” y “tablas_kw”, respectivamente). También se activa el paquete <a href="https://github.com/pgiraudoux/pgirmess">pgirmess</a>, que contiene la función para proceder a realizar la <em>prueba de comparaciones múltiples de Kruskal y Wallis</em>, <code><a href="https://rdrr.io/pkg/pgirmess/man/kruskalmc.html">kruskalmc()</a></code>:</p>
<div class="sourceCode" id="cb293"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># ¿Centroides estadísticamente significativos?</span></span>
<span></span>
<span>    <span class="co"># Vector de nombre de variables excluyendo la variable no deseada</span></span>
<span>      <span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">originales_so</span><span class="op">)</span>, <span class="st">"whatcluster_k"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Inicializar listas para almacenar gráficos y tablas</span></span>
<span>      <span class="va">graficos_kw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">tablas_kw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pgiraudoux/pgirmess">pgirmess</a></span><span class="op">)</span></span></code></pre></div>
<p>Luego, haremos un bucle para que se realice el gráfico de caja y se presente en una tabla el resultado de la <em>prueba de comparaciones múltiples de Kruskal y Wallis</em> para cada una de las variables. En la función para realizar la prueba, <code><a href="https://rdrr.io/pkg/pgirmess/man/kruskalmc.html">kruskalmc()</a></code>, la solución se guarda en un objeto, por ejemplo, “datos_kmc”, y los argumentos son, por un lado, la variable analizada y el factor que se utiliza para denominar los grupos (“whatcluster_k”), unidos por el símbolo “~”:</p>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Bucle para generar gráficos y análisis</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">variables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>         <span class="va">variable</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  </span>
<span>    <span class="co"># Crear el gráfico</span></span>
<span>      <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">originales_so</span>,</span>
<span>                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_.html">aes_string</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"whatcluster_k"</span>,</span>
<span>                             y <span class="op">=</span> <span class="va">variable</span>,</span>
<span>                             fill <span class="op">=</span> <span class="st">"whatcluster_k"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>outlier.shape <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>                        geom <span class="op">=</span> <span class="st">"point"</span>,</span>
<span>                        size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                        col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>                        geom <span class="op">=</span> <span class="st">"line"</span>,</span>
<span>                        col <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>                        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>   </span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                       size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                       col <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>                       alpha <span class="op">=</span> <span class="fl">0.40</span><span class="op">)</span> <span class="op">+</span></span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">variable</span>, <span class="st">". Comparación de grupos."</span><span class="op">)</span>,</span>
<span>                   subtitle <span class="op">=</span> <span class="st">"Empresas eólicas"</span><span class="op">)</span> <span class="op">+</span></span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Valor"</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="co"># Almacenar el gráfico en la lista</span></span>
<span>      <span class="va">graficos_kw</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span></span>
<span>  </span>
<span>    <span class="co"># Realizar el análisis de Kruskal-Wallis</span></span>
<span>      <span class="va">datos_kmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pgirmess/man/kruskalmc.html">kruskalmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">variable</span>, <span class="st">"~ whatcluster_k"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                             data <span class="op">=</span> <span class="va">originales_so</span><span class="op">)</span></span>
<span>      <span class="va">tabla</span> <span class="op">&lt;-</span> <span class="va">datos_kmc</span><span class="op">$</span><span class="va">dif.com</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>format <span class="op">=</span> <span class="va">knitr.table.format</span>,</span>
<span>                     caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"k-medias. Diferencias de Centroides"</span>,</span>
<span>                                     <span class="va">variable</span><span class="op">)</span>,</span>
<span>                     col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Diferencias centros"</span>,</span>
<span>                                   <span class="st">"Diferencias críticas"</span>,</span>
<span>                                   <span class="st">"Significación"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>full_width <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                             bootstrap_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"striped"</span>,</span>
<span>                                                   <span class="st">"bordered"</span>,</span>
<span>                                                   <span class="st">"condensed"</span><span class="op">)</span>,</span>
<span>                             position <span class="op">=</span> <span class="st">"center"</span>,</span>
<span>                             font_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fl">0</span>, bold <span class="op">=</span> <span class="cn">T</span>, align <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/row_spec.html">row_spec</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">datos_kmc</span><span class="op">$</span><span class="va">dif.com</span><span class="op">)</span>, bold <span class="op">=</span> <span class="cn">F</span>, align <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="co"># Almacenar la tabla en la lista</span></span>
<span>      <span class="va">tablas_kw</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tabla</span></span>
<span>    <span class="op">}</span></span></code></pre></div>
<p>Una vez almacenados, para cada variable clasificadora, los gráficos de caja y las tablas con los resultados de la prueba de comparaciones múltiples, quedan por realizar dos tareas: Agrupar los gráficos en composiciones de 4 (o menos) mediante la función <code>create_patchwork()</code> en la lista “gruposgraficos_kw”, y presentar todos los elementos:</p>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="co"># Crear composiciones de gráficos.</span></span>
<span></span>
<span>      <span class="va">gruposgraficos_kw</span> <span class="op">&lt;-</span> <span class="fu">create_patchwork</span><span class="op">(</span><span class="va">graficos_kw</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Mostrar los gráficos y tablas almacenados</span></span>
<span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">gruposgraficos_kw</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">gruposgraficos_kw</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span></code></pre></div>
<div class="inline-figure"><img src="RstarS_files/figure-html/unnamed-chunk-247-1.png" width="672"></div>
<div class="sourceCode" id="cb296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">tablas_kw</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tablas_kw</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span></code></pre></div>
<p>De los resultados del análisis de comparaciones múltiples de Kruskal y Wallis obtenidos, y teniendo en cuenta una significación estadística de 0,05; se obtienen las siguientes conclusiones:</p>
<ul>
<li><p>Variable de resultado (RES): en términos medios, solo existen diferencias estadísticamente significativas entre los resultados del ejercicio de las empresas del grupo 1, con respecto a los del grupo 2 y 3.</p></li>
<li><p>Variable de margen de beneficio (MARGEN): en términos medios, solo existen diferencias estadísticamente significativas entre el margen de beneficio de las empresas del grupo 2, en relación con los márgenes de las empresas de los grupos 1 y 3.</p></li>
<li><p>Variable de fondos propios (FPIOS): en términos medios, solo existen diferencias estadísticamente significativas en el volumen de fondos propios de las empresas del grupo 1, con respecto a los del grupo 2 y 3.</p></li>
<li><p>Variable de solvencia (SOLVENCIA): en términos medios, todas las diferencias en el grado de solvencia de las empresas de los distintos grupos son estadísticamente significativas.</p></li>
</ul>
<p>Finalmente. al centrarse nuestro objetivo en obtener perfiles de empresas más que en clasificar empresas concretas, y puesto que la muestra es numerosa, carece de sentido crear tablas con la información detallada de las empresas que componen cada uno, si bien la construcción de estas tablas es fácil, pudiéndose emplear el código que para tal objetivo se expuso en el apartado del análisis jerárquico. Lo que sí puede ser más interesante es mostrar como los elementos de cada grupo se disponen en los diagramas de dispersión producto de cruzar las variables clasificadoras entre sí. Para generar estos gráficos de un modo automatizado, primero generaremos un vector con el nombre de todas las variables (excluyendo al <em>factor</em> whatcluster_k mediante la función <code><a href="https://generics.r-lib.org/reference/setops.html">setdiff()</a></code>. Luego, crearemos una lista para ir almacenando los gráficos (lista “graficos”).Después, calcularemos todas las combinaciones de nombres de variables posibles, con la función <code><a href="https://rdrr.io/r/utils/combn.html">combn()</a></code>, y las almacenaremos en la lista “combinaciones”. En esta función, el argumento <strong><code>simplify = FALSE</code></strong> le dice a la función que no vuelque el resultado a una matriz:</p>
<div class="sourceCode" id="cb297"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># GRÁFICOS Variable vs Variable</span></span>
<span></span>
<span>  <span class="co"># Lista de variables excluyendo la variable no deseada</span></span>
<span>    <span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">originales_so</span><span class="op">)</span>, <span class="st">"whatcluster_k"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Lista para almacenar los gráficos</span></span>
<span>    <span class="va">graficos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Generar todas las combinaciones posibles de pares de variables</span></span>
<span>    <span class="va">combinaciones</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/combn.html">combn</a></span><span class="op">(</span><span class="va">variables</span>, <span class="fl">2</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Una vez almacenados los elementos anteriores, procederemos a crear los gráficos de dispersión mediante un bucle. Estos gráficos se guardarán en la lista “graficos”, que se pasará por la función <code>create_patchwork()</code> para que se sinteticen en composiciones de 4 (o menos) gráficos. Estas composiciones se almacenan en la lista “gruposgraficos”, y se presentan mediante un nuevo bucle:</p>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Bucle para crear y almacenar los gráficos</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">combinaciones</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>         <span class="va">var1</span> <span class="op">&lt;-</span> <span class="va">combinaciones</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>         <span class="va">var2</span> <span class="op">&lt;-</span> <span class="va">combinaciones</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>         <span class="va">grafico</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">originales_so</span>,</span>
<span>                           map <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_.html">aes_string</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">var1</span>,</span>
<span>                                            y <span class="op">=</span> <span class="va">var2</span>,</span>
<span>                                            color <span class="op">=</span> <span class="st">"whatcluster_k"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"GRÁFICO"</span>, <span class="va">var1</span>, <span class="st">"-"</span>, <span class="va">var2</span><span class="op">)</span>,</span>
<span>              subtitle <span class="op">=</span> <span class="st">"Empresas eólicas"</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span> <span class="op">(</span><span class="va">var1</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span> <span class="op">(</span><span class="va">var2</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span> </span>
<span>         <span class="va">graficos</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"grafico_"</span>, <span class="va">var1</span>, <span class="st">"_"</span>, <span class="va">var2</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">grafico</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Aplicar función de composiciones de patchwork</span></span>
<span></span>
<span>    <span class="va">gruposgraficos</span> <span class="op">&lt;-</span> <span class="fu">create_patchwork</span><span class="op">(</span><span class="va">graficos</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Presentar las composiciones</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">gruposgraficos</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">gruposgraficos</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span></code></pre></div>
<p><img src="RstarS_files/figure-html/unnamed-chunk-249-1.png" width="672"><img src="RstarS_files/figure-html/unnamed-chunk-249-2.png" width="672"></p>
<p>A partir de los gráficos anteriores se aprecia cómo, en coherencia con los resultados obtenidos en el análisis de las medias de los grupos, las empresas del grupo 1 poseen, en general valores en las variables de resultados y fondos propios superiores a los del resto de grupos (gráficos 1, 2, 3, 4 y 6). En cuanto al margen, el grueso de las empresas de los tres grupos poseen márgenes muy parecidos, con una leve tendencia de algunas empresas del grupo 3 a ser menores, y del grupo 1 a ser mayores (gráficos 1, 4 y 5). Con referencia a la solvencia, se distingue con claridad que las empresas del grupo 3 tienen, en general, un mayor nivel, destacando también la dispersión de la variable a lo largo del grupo 1 (gráficos 3, 5 y 6).</p>
</div>
<div id="materiales-para-realizar-las-prácticas-del-capítulo.-5" class="section level2" number="7.4">
<h2>
<span class="header-section-number">7.4</span> Materiales para realizar las prácticas del capítulo.<a class="anchor" aria-label="anchor" href="#materiales-para-realizar-las-pr%C3%A1cticas-del-cap%C3%ADtulo.-5"><i class="fas fa-link"></i></a>
</h2>
<p>En esta sección se muestran los links de acceso a los diferentes materiales (<em>scripts</em>, datos…) necesarios para llevar a cabo los contenidos prácticos del capítulo.</p>
<p><strong>Datos (en formato Microsoft (R) Excel (R)):</strong></p>
<ul>
<li>eolica_25.xlsx (<a href="https://docs.google.com/spreadsheets/d/1iwD8-e19IM6n_ZykP49i69_f_dLpzosx/edit?usp=sharing&amp;ouid=115375878280465826079&amp;rtpof=true&amp;sd=true">obtener aquí</a>)</li>
<li>eolica_350.xlsx (<a href="https://docs.google.com/spreadsheets/d/1Brtu_58lcfXL5ZTeOi9-xlxy7S9NfuxB/edit?usp=sharing&amp;ouid=115375878280465826079&amp;rtpof=true&amp;sd=true">obtener aquí</a>)</li>
</ul>
<p><strong>Scripts:</strong></p>
<ul>
<li>cluster_eolica.R (<a href="https://drive.google.com/file/d/1pxGjprMpfP_yqNsaJ-oWKJtfVnSbVZUh/view?usp=sharing">obtener aquí</a>)</li>
<li>kmedias_eolica.R (<a href="https://drive.google.com/file/d/1nOBc99SsMKYACitAVRD0nnpP8q-8FqJZ/view?usp=sharing">obtener aquí</a>)</li>
</ul>
<hr>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="componentes-principales..html"><span class="header-section-number">6</span> Componentes principales.</a></div>
<div class="next"><a href="an%C3%A1lisis-de-la-varianza..html"><span class="header-section-number">8</span> Análisis de la varianza.</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#an%C3%A1lisis-cl%C3%BAster."><span class="header-section-number">7</span> Análisis Clúster.</a></li>
<li><a class="nav-link" href="#introducci%C3%B3n.-3"><span class="header-section-number">7.1</span> Introducción.</a></li>
<li><a class="nav-link" href="#m%C3%A9todos-de-agrupaci%C3%B3n-jer%C3%A1rquicos."><span class="header-section-number">7.2</span> Métodos de agrupación jerárquicos.</a></li>
<li><a class="nav-link" href="#m%C3%A9todos-de-agrupaci%C3%B3n-no-jer%C3%A1rquicos."><span class="header-section-number">7.3</span> Métodos de agrupación no-jerárquicos.</a></li>
<li><a class="nav-link" href="#materiales-para-realizar-las-pr%C3%A1cticas-del-cap%C3%ADtulo.-5"><span class="header-section-number">7.4</span> Materiales para realizar las prácticas del capítulo.</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R-Stars: La Guía</strong>" was written by . It was last built on 2025-09-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
